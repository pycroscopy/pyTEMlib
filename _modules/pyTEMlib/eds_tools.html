<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyTEMlib.eds_tools &mdash; pyTEMlib 0.2024.01.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=d4dee072"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pyTEMlib
          </a>
              <div class="version">
                0.2024.01.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">pyTEMlib</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">pyTEMlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../revisions.html">Revisions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/pyTEMlib.html">pyTEMlib</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyTEMlib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyTEMlib.eds_tools</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyTEMlib.eds_tools</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">eds_tools</span>
<span class="sd">Model based quantification of energy-dispersive X-ray spectroscopy data</span>
<span class="sd">Copyright by Gerd Duscher</span>

<span class="sd">The University of Tennessee, Knoxville</span>
<span class="sd">Department of Materials Science &amp; Engineering</span>

<span class="sd">Sources:</span>
<span class="sd">   </span>
<span class="sd">Units:</span>
<span class="sd">    everything is in SI units, except length is given in nm and angles in mrad.</span>

<span class="sd">Usage:</span>
<span class="sd">    See the notebooks for examples of these routines</span>

<span class="sd">All the input and output is done through a dictionary which is to be found in the meta_data</span>
<span class="sd">attribute of the sidpy.Dataset</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">splrep</span>  <span class="c1"># splev, splint</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">peak_prominences</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span> <span class="nn">sklearn.mixture</span> <span class="kn">import</span> <span class="n">GaussianMixture</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">import</span> <span class="nn">scipy.constants</span> <span class="k">as</span> <span class="nn">const</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1"># import matplotlib.patches as patches</span>

<span class="c1"># from matplotlib.widgets import SpanSelector</span>
<span class="c1"># import ipywidgets as widgets</span>
<span class="c1"># from IPython.display import display</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">leastsq</span>  <span class="c1"># least square fitting routine fo scipy</span>

<span class="kn">import</span> <span class="nn">sidpy</span>

<span class="kn">import</span> <span class="nn">pickle</span>  <span class="c1"># pkg_resources</span>
<span class="kn">import</span> <span class="nn">pyTEMlib.eels_tools</span>
<span class="kn">from</span> <span class="nn">pyTEMlib.xrpa_x_sections</span> <span class="kn">import</span> <span class="n">x_sections</span>

<span class="n">elements_list</span> <span class="o">=</span> <span class="n">pyTEMlib</span><span class="o">.</span><span class="n">eels_tools</span><span class="o">.</span><span class="n">elements</span>

<span class="n">shell_occupancy</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;K1&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;L1&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;L3&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;M1&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;M2&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;M3&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;M4&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;M5&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> 
                 <span class="s1">&#39;N1&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;N2&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39; N3&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;N4&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;N5&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;N6&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;N7&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                 <span class="s1">&#39;O1&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;O2&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39; O3&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;O4&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;O5&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;O6&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;O7&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;O8&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;O9&#39;</span><span class="p">:</span> <span class="mi">10</span> <span class="p">}</span>


<div class="viewcode-block" id="detector_response"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.detector_response.html#pyTEMlib.eds_tools.detector_response">[docs]</a><span class="k">def</span> <span class="nf">detector_response</span><span class="p">(</span><span class="n">detector_definition</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates response of Si drift detector for EDS spectrum background based on detector parameters</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    detector_definition: dictionary</span>
<span class="sd">        definition of detector</span>
<span class="sd">    energy_scale: numpy array (1 dim)</span>
<span class="sd">        energy scale of spectrum should start at about 100eV!!</span>

<span class="sd">    Return:</span>
<span class="sd">    -------</span>
<span class="sd">    response: numpy array with length(energy_scale)</span>
<span class="sd">        detector response</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    tags ={}</span>
<span class="sd">    tags[&#39;acceleration_voltage_V&#39;] = 200000</span>

<span class="sd">    tags[&#39;detector&#39;] ={}</span>

<span class="sd">    ## layer thicknesses of commen materials in EDS detectors in m</span>
<span class="sd">    tags[&#39;detector&#39;][&#39;Al_thickness&#39;] = 0.03 * 1e-6  # in m</span>
<span class="sd">    tags[&#39;detector&#39;][&#39;Be_thickness&#39;] = 0.  # in m</span>
<span class="sd">    tags[&#39;detector&#39;][&#39;Au_thickness&#39;] = 0.0 * 1e-6  # in m</span>
<span class="sd">    tags[&#39;detector&#39;][&#39;Par_thickness&#39;] =  0 *1e-6  # in m   # Window</span>

<span class="sd">    tags[&#39;detector&#39;][&#39;SiDeadThickness&#39;] = .03 *1e-6  # in m</span>
<span class="sd">   </span>
<span class="sd">    tags[&#39;detector&#39;][&#39;SiLiveThickness&#39;] = 0.05  # in m</span>
<span class="sd">    tags[&#39;detector&#39;][&#39;detector_area&#39;] = 30 * 1e-6 #in m2</span>
<span class="sd">    tags[&#39;detector&#39;][&#39;resolution&#39;] = 125  # in eV</span>
<span class="sd">        </span>
<span class="sd">    energy_scale = np.linspace(.01,20,1199)*1000 # i eV</span>
<span class="sd">    start = np.searchsorted(spectrum.energy, 100)</span>
<span class="sd">    energy_scale = spectrum.energy[start:]</span>
<span class="sd">    detector_Efficiency= pyTEMlib.eds_tools.detector_response(tags, spectrum.energy[start:])</span>

<span class="sd">    p = np.array([1, 37, .3])/10000*3</span>
<span class="sd">    E_0= 200000</span>
<span class="sd">    background = np.zeros(len(spectrum))</span>
<span class="sd">    background[start:] = detector_Efficiency * (p[0] + p[1]*(E_0-energy_scale)/energy_scale + p[2]*(E_0-energy_scale)**2/energy_scale)</span>


<span class="sd">    plt.figure()</span>
<span class="sd">    plt.plot(spectrum.energy, spectrum, label = &#39;spec&#39;)</span>
<span class="sd">    plt.plot(spectrum.energy, background, label = &#39;background&#39;)</span>
<span class="sd">    plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">))</span>
    <span class="n">x_sections</span> <span class="o">=</span> <span class="n">pyTEMlib</span><span class="o">.</span><span class="n">eels_tools</span><span class="o">.</span><span class="n">get_x_sections</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_absorption</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">photoabsorption</span> <span class="o">=</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">Z</span><span class="p">)][</span><span class="s1">&#39;dat&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e10</span><span class="o">/</span><span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">Z</span><span class="p">)][</span><span class="s1">&#39;photoabs_to_sigma&#39;</span><span class="p">]</span>
        <span class="n">lin</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">Z</span><span class="p">)][</span><span class="s1">&#39;ene&#39;</span><span class="p">],</span> <span class="n">photoabsorption</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span> 
        <span class="n">mu</span> <span class="o">=</span> <span class="n">lin</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">Z</span><span class="p">)][</span><span class="s1">&#39;nominal_density&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span> <span class="c1">#1/cm -&gt; 1/m</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">mu</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s1">&#39;Al_thickness&#39;</span> <span class="ow">in</span>  <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]:</span>
        <span class="n">response</span> <span class="o">*=</span> <span class="n">get_absorption</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">][</span><span class="s1">&#39;Al_thickness&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;Be_thickness&#39;</span> <span class="ow">in</span>  <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]:</span>
        <span class="n">response</span> <span class="o">*=</span> <span class="n">get_absorption</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">][</span><span class="s1">&#39;Be_thickness&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;Au_thickness&#39;</span> <span class="ow">in</span>  <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]:</span>
        <span class="n">response</span> <span class="o">*=</span> <span class="n">get_absorption</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span> <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">][</span><span class="s1">&#39;Au_thickness&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;Par_thickness&#39;</span> <span class="ow">in</span>  <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]:</span>
        <span class="n">response</span> <span class="o">*=</span> <span class="n">get_absorption</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">][</span><span class="s1">&#39;Par_thickness&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;SiDeadThickness&#39;</span> <span class="ow">in</span>  <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]:</span>
        <span class="n">response</span> <span class="o">*=</span> <span class="n">get_absorption</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">][</span><span class="s1">&#39;SiDeadThickness&#39;</span><span class="p">])</span>
        
    <span class="k">if</span> <span class="s1">&#39;SiLiveThickness&#39;</span> <span class="ow">in</span>  <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]:</span>
        <span class="n">response</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">-</span><span class="n">get_absorption</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="n">detector_definition</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">][</span><span class="s1">&#39;SiLiveThickness&#39;</span><span class="p">])</span>
       
    <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="detect_peaks"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.detect_peaks.html#pyTEMlib.eds_tools.detect_peaks">[docs]</a><span class="k">def</span> <span class="nf">detect_peaks</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">minimum_number_of_peaks</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Needs an sidpy dataset&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;SPECTRUM&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Need a spectrum&#39;</span><span class="p">)</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="mi">138</span>
    <span class="k">if</span> <span class="s1">&#39;EDS&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;energy_resolution&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;EDS&#39;</span><span class="p">]:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;EDS&#39;</span><span class="p">][</span><span class="s1">&#39;energy_resolution&#39;</span><span class="p">]</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">energy_scale</span><span class="p">,</span> <span class="mi">125</span><span class="p">)</span>
    <span class="c1">## we use half the width of the resolution for smearing</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">125</span><span class="o">/</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">energy_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dataset</span><span class="o">.</span><span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">new_spectrum</span> <span class="o">=</span>  <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">start</span><span class="p">:],</span> <span class="n">width</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">## we use half the width of the resolution for smearing</span>
    <span class="c1">#new_energy_scale = dataset.energy_scale[start:]</span>
    <span class="n">prominence</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">minor_peaks</span><span class="p">,</span> <span class="n">_</span>  <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">new_spectrum</span><span class="p">,</span> <span class="n">prominence</span><span class="o">=</span><span class="n">prominence</span><span class="p">)</span>
    
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">minor_peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">minimum_number_of_peaks</span><span class="p">:</span>
        <span class="n">prominence</span><span class="o">+=</span><span class="mi">10</span>
        <span class="n">minor_peaks</span><span class="p">,</span> <span class="n">_</span>  <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">new_spectrum</span><span class="p">,</span> <span class="n">prominence</span><span class="o">=</span><span class="n">prominence</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">minor_peaks</span><span class="p">)</span><span class="o">+</span><span class="n">start</span></div>

<div class="viewcode-block" id="find_elements"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.find_elements.html#pyTEMlib.eds_tools.find_elements">[docs]</a><span class="k">def</span> <span class="nf">find_elements</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">minor_peaks</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39; Need a sidpy dataset&#39;</span><span class="p">)</span>
    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energy_scale</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">minor_peaks</span><span class="p">:</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">82</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;lines&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)]:</span>
                <span class="k">if</span> <span class="s1">&#39;K-L3&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="s1">&#39;K-L3&#39;</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span><span class="o">-</span> <span class="n">energy_scale</span><span class="p">[</span><span class="n">peak</span><span class="p">])</span> <span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span>  <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
                            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;K-L2&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="s1">&#39;K-L2&#39;</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span><span class="o">-</span> <span class="n">energy_scale</span><span class="p">[</span><span class="n">peak</span><span class="p">])</span> <span class="o">&lt;</span><span class="mi">10</span><span class="p">:</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span>  <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
                                <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;L3-M5&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="s1">&#39;L3-M5&#39;</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span><span class="o">-</span> <span class="n">energy_scale</span><span class="p">[</span><span class="n">peak</span><span class="p">])</span> <span class="o">&lt;</span><span class="mi">30</span><span class="p">:</span>
                              <span class="k">if</span>  <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
                                    <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">elements</span></div>

<div class="viewcode-block" id="get_x_ray_lines"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.get_x_ray_lines.html#pyTEMlib.eds_tools.get_x_ray_lines">[docs]</a><span class="k">def</span> <span class="nf">get_x_ray_lines</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">elements</span><span class="p">):</span>
    <span class="n">out_tags</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">alpha_K</span> <span class="o">=</span> <span class="mf">1e6</span>
    <span class="n">alpha_L</span> <span class="o">=</span> <span class="mf">6.5e7</span>
    <span class="n">alpha_M</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="mf">1e8</span><span class="c1">#2.2e10</span>
    <span class="c1"># My Fit</span>
    <span class="n">alpha_K</span> <span class="o">=</span> <span class="mf">.9e6</span>
    <span class="n">alpha_L</span> <span class="o">=</span> <span class="mf">6.e7</span>
    <span class="n">alpha_M</span> <span class="o">=</span> <span class="mi">6</span><span class="o">*</span><span class="mf">1e8</span><span class="c1">#2.2e10</span>
    <span class="c1"># omega_K = Z**4/(alpha_K+Z**4)</span>
    <span class="c1"># omega_L = Z**4/(alpha_L+Z**4)</span>
    <span class="c1"># omega_M = Z**4/(alpha_M+Z**4)</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>

        <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">elements_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span><span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">atomic_number</span><span class="p">}</span>
        <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energy</span>
        <span class="k">if</span> <span class="s1">&#39;K-L3&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="s1">&#39;K-L3&#39;</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.9e4</span><span class="p">:</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="s1">&#39;K-L3&#39;</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="p">)]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
                <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;K-family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">}</span>
                <span class="k">if</span> <span class="s1">&#39;K&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;fluorescent_yield&#39;</span><span class="p">]:</span>
                    <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;K-family&#39;</span><span class="p">][</span><span class="s1">&#39;yield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;fluorescent_yield&#39;</span><span class="p">][</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;K-family&#39;</span><span class="p">][</span><span class="s1">&#39;yield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_number</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_K</span><span class="o">+</span><span class="n">atomic_number</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="mf">1.4</span>

        <span class="k">if</span> <span class="s1">&#39;L3-M5&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="s1">&#39;L3-M5&#39;</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.9e4</span><span class="p">:</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="s1">&#39;L3-M5&#39;</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="p">)]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
                <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;L-family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">}</span>
                <span class="k">if</span> <span class="s1">&#39;L&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;fluorescent_yield&#39;</span><span class="p">]:</span>
                    <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;L-family&#39;</span><span class="p">][</span><span class="s1">&#39;yield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;fluorescent_yield&#39;</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;L-family&#39;</span><span class="p">][</span><span class="s1">&#39;yield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">atomic_number</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_L</span><span class="o">+</span><span class="n">atomic_number</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">if</span> <span class="s1">&#39;M5-N6&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="s1">&#39;M5-N6&#39;</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.9e4</span><span class="p">:</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="s1">&#39;M5-N7&#39;</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="p">)]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
                <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;M-family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">}</span>
                <span class="k">if</span> <span class="s1">&#39;M&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;fluorescent_yield&#39;</span><span class="p">]:</span>
                    <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;M-family&#39;</span><span class="p">][</span><span class="s1">&#39;yield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;fluorescent_yield&#39;</span><span class="p">][</span><span class="s1">&#39;M&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;M-family&#39;</span><span class="p">][</span><span class="s1">&#39;yield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">atomic_number</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_M</span><span class="o">+</span><span class="n">atomic_number</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">other</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">3e4</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;K-family&#39;</span> <span class="ow">in</span> <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span>
                        <span class="n">other</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;K-family&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">line</span>
                <span class="k">if</span> <span class="s1">&#39;L-family&#39;</span> <span class="ow">in</span> <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">key</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="s1">&#39;L3&#39;</span><span class="p">]:</span>
                        <span class="n">other</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;L-family&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">line</span>
                <span class="k">if</span> <span class="s1">&#39;M-family&#39;</span> <span class="ow">in</span> <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">key</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M5&#39;</span><span class="p">,</span> <span class="s1">&#39;M4&#39;</span><span class="p">]:</span>
                        <span class="n">other</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;M-family&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">line</span>
                <span class="k">if</span> <span class="n">other</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;other&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">]:</span>
                        <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="p">)]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
                    <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;other&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">line</span>
                    <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;other&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span>
      
        <span class="n">xs</span> <span class="o">=</span> <span class="n">get_eds_cross_sections</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;K&#39;</span> <span class="ow">in</span> <span class="n">xs</span> <span class="ow">and</span> <span class="s1">&#39;K-family&#39;</span> <span class="ow">in</span> <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">]:</span>
            <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;K-family&#39;</span><span class="p">][</span><span class="s1">&#39;ionization_x_section&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;L&#39;</span> <span class="ow">in</span> <span class="n">xs</span> <span class="ow">and</span> <span class="s1">&#39;L-family&#39;</span> <span class="ow">in</span> <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">]:</span>
            <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;L-family&#39;</span><span class="p">][</span><span class="s1">&#39;ionization_x_section&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;M&#39;</span> <span class="ow">in</span> <span class="n">xs</span> <span class="ow">and</span> <span class="s1">&#39;M-family&#39;</span> <span class="ow">in</span> <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">]:</span>
            <span class="n">out_tags</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;M-family&#39;</span><span class="p">][</span><span class="s1">&#39;ionization_x_section&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for key, x_lines in out_tags.items():</span>
<span class="sd">        if &#39;K-family&#39; in x_lines:</span>
<span class="sd">            xs = pyTEMlib.eels_tools.xsec_xrpa(np.arange(100)+x_sections[str(x_lines[&#39;Z&#39;])][&#39;K1&#39;][&#39;onset&#39;], 200,x_lines[&#39;Z&#39;], 100).sum()</span>

<span class="sd">            x_lines[&#39;K-family&#39;][&#39;ionization_x_section&#39;] = xs</span>
<span class="sd">            </span>
<span class="sd">        if &#39;L-family&#39; in x_lines:</span>
<span class="sd">            xs = pyTEMlib.eels_tools.xsec_xrpa(np.arange(100)+x_sections[str(x_lines[&#39;Z&#39;])][&#39;L3&#39;][&#39;onset&#39;], 200,x_lines[&#39;Z&#39;], 100).sum()</span>
<span class="sd">            x_lines[&#39;L-family&#39;][&#39;ionization_x_section&#39;] = xs</span>
<span class="sd">        if &#39;M-family&#39; in x_lines:</span>
<span class="sd">            xs = pyTEMlib.eels_tools.xsec_xrpa(np.arange(100)+x_sections[str(x_lines[&#39;Z&#39;])][&#39;M5&#39;][&#39;onset&#39;], 200,x_lines[&#39;Z&#39;], 100).sum()</span>
<span class="sd">            x_lines[&#39;M-family&#39;][&#39;ionization_x_section&#39;] = xs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">out_tags</span></div>


<div class="viewcode-block" id="getFWHM"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.getFWHM.html#pyTEMlib.eds_tools.getFWHM">[docs]</a><span class="k">def</span> <span class="nf">getFWHM</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">E_ref</span><span class="p">,</span> <span class="n">FWHM_ref</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="p">(</span><span class="n">E</span><span class="o">-</span><span class="n">E_ref</span><span class="p">)</span><span class="o">+</span><span class="n">FWHM_ref</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="gaussian"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.gaussian.html#pyTEMlib.eds_tools.gaussian">[docs]</a><span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">enrgy_scale</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">FWHM</span><span class="p">):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">FWHM</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">enrgy_scale</span> <span class="o">-</span> <span class="n">mu</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)))</span></div>

<div class="viewcode-block" id="get_peak"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.get_peak.html#pyTEMlib.eds_tools.get_peak">[docs]</a><span class="k">def</span> <span class="nf">get_peak</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">):</span>
    <span class="n">E_ref</span> <span class="o">=</span> <span class="mf">5895.0</span>
    <span class="n">FWHM_ref</span> <span class="o">=</span> <span class="mi">136</span> <span class="c1">#eV</span>
    <span class="n">FWHM</span>  <span class="o">=</span> <span class="n">getFWHM</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">E_ref</span><span class="p">,</span> <span class="n">FWHM_ref</span><span class="p">)</span>
    <span class="n">gaus</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">FWHM</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gaus</span> <span class="o">/</span><span class="n">gaus</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_model"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.get_model.html#pyTEMlib.eds_tools.get_model">[docs]</a><span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">):</span>

    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energy</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">lines</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;K-family&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;K-family&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">+=</span> <span class="n">get_peak</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">energy_scale</span><span class="p">)</span><span class="o">*</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
            <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;K-family&#39;</span><span class="p">][</span><span class="s1">&#39;peaks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;K-family&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;K-family&#39;</span><span class="p">][</span><span class="s1">&#39;peaks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s1">&#39;K-family&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">])</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s1">&#39;K-family&#39;</span><span class="p">][</span><span class="s1">&#39;peaks&#39;</span><span class="p">])</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">+</span><span class="s1">&#39;:K-family&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;L-family&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;L-family&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">+=</span> <span class="n">get_peak</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">energy_scale</span><span class="p">)</span><span class="o">*</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
            <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;L-family&#39;</span><span class="p">][</span><span class="s1">&#39;peaks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;L-family&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;L-family&#39;</span><span class="p">][</span><span class="s1">&#39;peaks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s1">&#39;L-family&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">])</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s1">&#39;L-family&#39;</span><span class="p">][</span><span class="s1">&#39;peaks&#39;</span><span class="p">])</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">+</span><span class="s1">&#39;:L-family&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;M-family&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;M-family&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">+=</span> <span class="n">get_peak</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">energy_scale</span><span class="p">)</span><span class="o">*</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
            <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;M-family&#39;</span><span class="p">][</span><span class="s1">&#39;peaks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;M-family&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;M-family&#39;</span><span class="p">][</span><span class="s1">&#39;peaks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s1">&#39;M-family&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">])</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s1">&#39;M-family&#39;</span><span class="p">][</span><span class="s1">&#39;peaks&#39;</span><span class="p">])</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">+</span><span class="s1">&#39;:M-family&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="s1">&#39;other&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">get_peak</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">energy_scale</span><span class="p">)</span>
                <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">])</span>
                <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">])</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">+</span><span class="s1">&#39;:other:&#39;</span><span class="o">+</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">keys</span></div>

<div class="viewcode-block" id="fit_model"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.fit_model.html#pyTEMlib.eds_tools.fit_model">[docs]</a><span class="k">def</span> <span class="nf">fit_model</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span>  <span class="n">detector_Efficiency</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
    <span class="n">out_tags</span> <span class="o">=</span> <span class="n">get_x_ray_lines</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">elements</span><span class="p">)</span>
    
    <span class="n">peaks</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="n">out_tags</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">energy</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span>
    
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mf">.3</span><span class="p">])</span><span class="o">/</span><span class="mi">100000</span><span class="o">*</span><span class="mi">3</span>
    <span class="n">E_0</span><span class="o">=</span> <span class="mi">200000</span>
    <span class="n">pin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pin</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">residuals</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">+=</span> <span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">pp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">detector_Efficiency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">detector_Efficiency</span> <span class="o">*</span> <span class="p">(</span><span class="n">pp</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">E_0</span><span class="o">-</span><span class="n">energy_scale</span><span class="p">)</span><span class="o">/</span><span class="n">energy_scale</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">E_0</span><span class="o">-</span><span class="n">energy_scale</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">energy_scale</span><span class="p">)</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">yy</span> <span class="o">-</span> <span class="n">model</span><span class="p">)[</span><span class="n">start</span><span class="p">:])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">start</span><span class="p">:]))</span>
        <span class="k">return</span> <span class="n">err</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">update_fit_values</span><span class="p">(</span><span class="n">out_tags</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;EDS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;EDS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;EDS&#39;</span><span class="p">][</span><span class="s1">&#39;lines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_tags</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_fit_values"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.update_fit_values.html#pyTEMlib.eds_tools.update_fit_values">[docs]</a><span class="k">def</span> <span class="nf">update_fit_values</span><span class="p">(</span><span class="n">out_tags</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">lines</span> <span class="ow">in</span> <span class="n">out_tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;K-family&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;K-family&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;L-family&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;L-family&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;M-family&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;M-family&#39;</span><span class="p">][</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;other&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span></div>
                

<div class="viewcode-block" id="get_eds_xsection"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.get_eds_xsection.html#pyTEMlib.eds_tools.get_eds_xsection">[docs]</a><span class="k">def</span> <span class="nf">get_eds_xsection</span><span class="p">(</span><span class="n">Xsection</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="n">start_bgd</span><span class="p">,</span> <span class="n">end_bgd</span><span class="p">):</span>
    <span class="n">background</span> <span class="o">=</span> <span class="n">pyTEMlib</span><span class="o">.</span><span class="n">eels_tools</span><span class="o">.</span><span class="n">power_law_background</span><span class="p">(</span><span class="n">Xsection</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="p">[</span><span class="n">start_bgd</span><span class="p">,</span> <span class="n">end_bgd</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cross_section_core</span> <span class="o">=</span> <span class="n">Xsection</span><span class="o">-</span> <span class="n">background</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cross_section_core</span><span class="p">[</span><span class="n">cross_section_core</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cross_section_core</span><span class="p">[</span><span class="n">energy_scale</span> <span class="o">&lt;</span> <span class="n">end_bgd</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">cross_section_core</span></div>


<div class="viewcode-block" id="get_eds_cross_sections"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.get_eds_cross_sections.html#pyTEMlib.eds_tools.get_eds_cross_sections">[docs]</a><span class="k">def</span> <span class="nf">get_eds_cross_sections</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span>
    <span class="n">Xsection</span> <span class="o">=</span> <span class="n">pyTEMlib</span><span class="o">.</span><span class="n">eels_tools</span><span class="o">.</span><span class="n">xsec_xrpa</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="mf">400.</span><span class="p">)</span>
    <span class="n">edge_info</span> <span class="o">=</span> <span class="n">pyTEMlib</span><span class="o">.</span><span class="n">eels_tools</span><span class="o">.</span><span class="n">get_x_sections</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">eds_cross_sections</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;K1&#39;</span> <span class="ow">in</span> <span class="n">edge_info</span><span class="p">:</span>
        <span class="n">start_bgd</span> <span class="o">=</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;K1&#39;</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.8</span>
        <span class="n">end_bgd</span> <span class="o">=</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;K1&#39;</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span>  <span class="o">-</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">start_bgd</span> <span class="o">&gt;</span> <span class="n">end_bgd</span><span class="p">:</span>
            <span class="n">start_bgd</span> <span class="o">=</span> <span class="n">end_bgd</span><span class="o">-</span><span class="mi">100</span>
        <span class="k">if</span> <span class="n">start_bgd</span> <span class="o">&gt;</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">end_bgd</span><span class="o">&lt;</span> <span class="n">energy_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">100</span><span class="p">:</span>
            <span class="n">eds_xsection</span> <span class="o">=</span> <span class="n">get_eds_xsection</span><span class="p">(</span><span class="n">Xsection</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="n">start_bgd</span><span class="p">,</span> <span class="n">end_bgd</span><span class="p">)</span>
            <span class="n">eds_xsection</span> <span class="o">=</span> <span class="n">Xsection</span> <span class="o">-</span> <span class="n">eds_xsection</span>
            <span class="n">eds_xsection</span><span class="p">[</span><span class="n">eds_xsection</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">start_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;K1&#39;</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">])</span>
            <span class="n">eds_cross_sections</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eds_xsection</span><span class="p">[</span><span class="n">start_sum</span><span class="p">:</span><span class="n">start_sum</span><span class="o">+</span><span class="mi">200</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
    <span class="k">if</span> <span class="s1">&#39;L3&#39;</span> <span class="ow">in</span> <span class="n">edge_info</span><span class="p">:</span>
        <span class="n">start_bgd</span> <span class="o">=</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;L3&#39;</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.8</span>
        <span class="n">end_bgd</span> <span class="o">=</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;L3&#39;</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span>  <span class="o">-</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">start_bgd</span> <span class="o">&gt;</span> <span class="n">end_bgd</span><span class="p">:</span>
            <span class="n">start_bgd</span> <span class="o">=</span> <span class="n">end_bgd</span><span class="o">-</span><span class="mi">100</span>
        <span class="k">if</span> <span class="n">start_bgd</span> <span class="o">&gt;</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">end_bgd</span><span class="o">&lt;</span> <span class="n">energy_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">100</span><span class="p">:</span>
            <span class="n">eds_xsection</span> <span class="o">=</span> <span class="n">get_eds_xsection</span><span class="p">(</span><span class="n">Xsection</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="n">start_bgd</span><span class="p">,</span> <span class="n">end_bgd</span><span class="p">)</span>
            <span class="n">eds_xsection</span> <span class="o">=</span> <span class="n">Xsection</span> <span class="o">-</span> <span class="n">eds_xsection</span>
            <span class="n">eds_xsection</span><span class="p">[</span><span class="n">eds_xsection</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">start_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;L3&#39;</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">])</span>
            <span class="n">eds_cross_sections</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eds_xsection</span><span class="p">[</span><span class="n">start_sum</span><span class="p">:</span><span class="n">start_sum</span><span class="o">+</span><span class="mi">200</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
    <span class="k">if</span> <span class="s1">&#39;M5&#39;</span> <span class="ow">in</span> <span class="n">edge_info</span><span class="p">:</span>
        <span class="n">start_bgd</span> <span class="o">=</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;M5&#39;</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.8</span>
        <span class="n">end_bgd</span> <span class="o">=</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;M5&#39;</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span>  <span class="o">-</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">start_bgd</span> <span class="o">&gt;</span> <span class="n">end_bgd</span><span class="p">:</span>
            <span class="n">start_bgd</span> <span class="o">=</span> <span class="n">end_bgd</span><span class="o">-</span><span class="mi">100</span>
        <span class="k">if</span> <span class="n">start_bgd</span> <span class="o">&gt;</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">end_bgd</span><span class="o">&lt;</span> <span class="n">energy_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">100</span><span class="p">:</span>
            <span class="n">eds_xsection</span> <span class="o">=</span> <span class="n">get_eds_xsection</span><span class="p">(</span><span class="n">Xsection</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="n">start_bgd</span><span class="p">,</span> <span class="n">end_bgd</span><span class="p">)</span>
            <span class="n">eds_xsection</span> <span class="o">=</span> <span class="n">Xsection</span> <span class="o">-</span> <span class="n">eds_xsection</span>
            <span class="n">eds_xsection</span><span class="p">[</span><span class="n">eds_xsection</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">start_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;M5&#39;</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">])</span>
            <span class="n">eds_cross_sections</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eds_xsection</span><span class="p">[</span><span class="n">start_sum</span><span class="p">:</span><span class="n">start_sum</span><span class="o">+</span><span class="mi">200</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
    <span class="k">return</span> <span class="n">eds_cross_sections</span></div>


<div class="viewcode-block" id="get_phases"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.get_phases.html#pyTEMlib.eds_tools.get_phases">[docs]</a><span class="k">def</span> <span class="nf">get_phases</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;kmeans&#39;</span><span class="p">,</span> <span class="n">number_of_phases</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">X_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">X_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">X_vec</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X_vec</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;kmeans&#39;</span><span class="p">:</span>
        <span class="n">gmm</span> <span class="o">=</span> <span class="n">GaussianMixture</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">number_of_phases</span><span class="p">,</span> <span class="n">covariance_type</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">)</span> <span class="c1">#choose number of components</span>

        <span class="n">gmm_results</span> <span class="o">=</span> <span class="n">gmm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_vec</span><span class="p">))</span> <span class="c1">#we can intelligently fold the data and perform GM</span>
        <span class="n">gmm_labels</span> <span class="o">=</span> <span class="n">gmm_results</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">X_vec</span><span class="p">)</span>

        <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;gaussian_mixing_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">gmm_labels</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                                    <span class="s1">&#39;covariances&#39;</span><span class="p">:</span> <span class="n">gmm</span><span class="o">.</span><span class="n">covariances_</span><span class="p">,</span>
                                                    <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">gmm</span><span class="o">.</span><span class="n">weights_</span><span class="p">,</span>
                                                    <span class="s1">&#39;means&#39;</span><span class="p">:</span>  <span class="n">gmm_results</span><span class="o">.</span><span class="n">means_</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">number_of_phases</span><span class="p">,</span> <span class="n">n_init</span> <span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1">#choose number of clusters</span>
        <span class="n">km_results</span> <span class="o">=</span> <span class="n">km</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_vec</span><span class="p">))</span> <span class="c1">#we can intelligently fold the data and perform Kmeans</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;kmeans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">km_results</span><span class="o">.</span><span class="n">labels_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                      <span class="s1">&#39;means&#39;</span><span class="p">:</span> <span class="n">km_results</span><span class="o">.</span><span class="n">cluster_centers_</span><span class="p">}</span></div>

<div class="viewcode-block" id="plot_phases"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eds_tools.plot_phases.html#pyTEMlib.eds_tools.plot_phases">[docs]</a><span class="k">def</span> <span class="nf">plot_phases</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">survey_image</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">survey_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">axis_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">survey_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">survey_image</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">axis_index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1">#if &#39;gaussian_mixing_model&#39; in dataset.metadata:</span>
    <span class="c1">#    phase_spectra = dataset.metadata[&#39;gaussian_mixing_model&#39;][&#39;means&#39;]</span>
    <span class="c1">#   map = dataset.metadata[&#39;gaussian_mixing_model&#39;][&#39;map&#39;]</span>
    <span class="c1">#el</span>
    <span class="k">if</span> <span class="s1">&#39;kmeans&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
        <span class="n">phase_spectra</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;kmeans&#39;</span><span class="p">][</span><span class="s1">&#39;means&#39;</span><span class="p">]</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;kmeans&#39;</span><span class="p">][</span><span class="s1">&#39;map&#39;</span><span class="p">]</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase_spectra</span><span class="p">))</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">axis_index</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">axis_index</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
                          <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">axis_index</span><span class="p">])</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase_spectra</span><span class="p">)</span> <span class="p">))</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;GMM Phase&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span>
    <span class="n">axis_index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phase_spectra</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">axis_index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">energy</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">axis_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;energy (keV)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Gerd Duscher, and contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>