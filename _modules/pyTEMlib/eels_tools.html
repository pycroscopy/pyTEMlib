<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyTEMlib.eels_tools &mdash; pyTEMlib 0.2024.01.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=d4dee072"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pyTEMlib
          </a>
              <div class="version">
                0.2024.01.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">pyTEMlib</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">pyTEMlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../revisions.html">Revisions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/pyTEMlib.html">pyTEMlib</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyTEMlib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyTEMlib.eels_tools</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyTEMlib.eels_tools</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">eels_tools</span>
<span class="sd">Model based quantification of electron energy-loss data</span>
<span class="sd">Copyright by Gerd Duscher</span>

<span class="sd">The University of Tennessee, Knoxville</span>
<span class="sd">Department of Materials Science &amp; Engineering</span>

<span class="sd">Sources:</span>
<span class="sd">   M. Tian et al.</span>

<span class="sd">Units:</span>
<span class="sd">    everything is in SI units, except length is given in nm and angles in mrad.</span>

<span class="sd">Usage:</span>
<span class="sd">    See the notebooks for examples of these routines</span>

<span class="sd">All the input and output is done through a dictionary which is to be found in the meta_data</span>
<span class="sd">attribute of the sidpy.Dataset</span>

<span class="sd">Update by Austin Houston, UTK 12-2023 : Parallization of spectrum images</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">splrep</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">peak_prominences</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span><span class="p">,</span> <span class="n">leastsq</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># ## And we use the image tool library of pyTEMlib</span>
<span class="kn">from</span> <span class="nn">pyTEMlib.xrpa_x_sections</span> <span class="kn">import</span> <span class="n">x_sections</span>

<span class="kn">import</span> <span class="nn">sidpy</span>
<span class="kn">from</span> <span class="nn">sidpy.proc.fitter</span> <span class="kn">import</span> <span class="n">SidFitter</span>
<span class="kn">from</span> <span class="nn">sidpy.base.num_utils</span> <span class="kn">import</span> <span class="n">get_slope</span>

<span class="c1"># we have a function called find peaks - is it necessary?</span>
<span class="c1"># or could we just use scipy.signal import find_peaks</span>

<span class="n">major_edges</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;K1&#39;</span><span class="p">,</span> <span class="s1">&#39;L3&#39;</span><span class="p">,</span> <span class="s1">&#39;M5&#39;</span><span class="p">,</span> <span class="s1">&#39;N5&#39;</span><span class="p">]</span>
<span class="n">all_edges</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;K1&#39;</span><span class="p">,</span> <span class="s1">&#39;L1&#39;</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="s1">&#39;L3&#39;</span><span class="p">,</span> <span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;M2&#39;</span><span class="p">,</span> <span class="s1">&#39;M3&#39;</span><span class="p">,</span> <span class="s1">&#39;M4&#39;</span><span class="p">,</span> <span class="s1">&#39;M5&#39;</span><span class="p">,</span> <span class="s1">&#39;N1&#39;</span><span class="p">,</span> <span class="s1">&#39;N2&#39;</span><span class="p">,</span> <span class="s1">&#39;N3&#39;</span><span class="p">,</span> <span class="s1">&#39;N4&#39;</span><span class="p">,</span> <span class="s1">&#39;N5&#39;</span><span class="p">,</span> <span class="s1">&#39;N6&#39;</span><span class="p">,</span> <span class="s1">&#39;N7&#39;</span><span class="p">,</span> <span class="s1">&#39;O1&#39;</span><span class="p">,</span> <span class="s1">&#39;O2&#39;</span><span class="p">,</span>
             <span class="s1">&#39;O3&#39;</span><span class="p">,</span> <span class="s1">&#39;O4&#39;</span><span class="p">,</span> <span class="s1">&#39;O5&#39;</span><span class="p">,</span> <span class="s1">&#39;O6&#39;</span><span class="p">,</span> <span class="s1">&#39;O7&#39;</span><span class="p">,</span> <span class="s1">&#39;P1&#39;</span><span class="p">,</span> <span class="s1">&#39;P2&#39;</span><span class="p">,</span> <span class="s1">&#39;P3&#39;</span><span class="p">]</span>
<span class="n">first_close_edges</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;K1&#39;</span><span class="p">,</span> <span class="s1">&#39;L3&#39;</span><span class="p">,</span> <span class="s1">&#39;M5&#39;</span><span class="p">,</span> <span class="s1">&#39;M3&#39;</span><span class="p">,</span> <span class="s1">&#39;N5&#39;</span><span class="p">,</span> <span class="s1">&#39;N3&#39;</span><span class="p">]</span>

<span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;He&#39;</span><span class="p">,</span> <span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Be&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;Ne&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Mg&#39;</span><span class="p">,</span> <span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="s1">&#39;Si&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;Ar&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;Ca&#39;</span><span class="p">,</span> <span class="s1">&#39;Sc&#39;</span><span class="p">,</span> <span class="s1">&#39;Ti&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Cr&#39;</span><span class="p">,</span> <span class="s1">&#39;Mn&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;Co&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="s1">&#39;Zn&#39;</span><span class="p">,</span> <span class="s1">&#39;Ga&#39;</span><span class="p">,</span> <span class="s1">&#39;Ge&#39;</span><span class="p">,</span> <span class="s1">&#39;As&#39;</span><span class="p">,</span> <span class="s1">&#39;Se&#39;</span><span class="p">,</span> <span class="s1">&#39;Br&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Kr&#39;</span><span class="p">,</span> <span class="s1">&#39;Rb&#39;</span><span class="p">,</span> <span class="s1">&#39;Sr&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Zr&#39;</span><span class="p">,</span> <span class="s1">&#39;Nb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mo&#39;</span><span class="p">,</span> <span class="s1">&#39;Tc&#39;</span><span class="p">,</span> <span class="s1">&#39;Ru&#39;</span><span class="p">,</span> <span class="s1">&#39;Rh&#39;</span><span class="p">,</span> <span class="s1">&#39;Pd&#39;</span><span class="p">,</span> <span class="s1">&#39;Ag&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Cd&#39;</span><span class="p">,</span> <span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="s1">&#39;Sn&#39;</span><span class="p">,</span> <span class="s1">&#39;Sb&#39;</span><span class="p">,</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;Xe&#39;</span><span class="p">,</span> <span class="s1">&#39;Cs&#39;</span><span class="p">,</span> <span class="s1">&#39;Ba&#39;</span><span class="p">,</span> <span class="s1">&#39;La&#39;</span><span class="p">,</span> <span class="s1">&#39;Ce&#39;</span><span class="p">,</span> <span class="s1">&#39;Pr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Nd&#39;</span><span class="p">,</span> <span class="s1">&#39;Pm&#39;</span><span class="p">,</span> <span class="s1">&#39;Sm&#39;</span><span class="p">,</span> <span class="s1">&#39;Eu&#39;</span><span class="p">,</span> <span class="s1">&#39;Gd&#39;</span><span class="p">,</span> <span class="s1">&#39;Tb&#39;</span><span class="p">,</span> <span class="s1">&#39;Dy&#39;</span><span class="p">,</span> <span class="s1">&#39;Ho&#39;</span><span class="p">,</span> <span class="s1">&#39;Er&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm&#39;</span><span class="p">,</span> <span class="s1">&#39;Yb&#39;</span><span class="p">,</span> <span class="s1">&#39;Lu&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Hf&#39;</span><span class="p">,</span> <span class="s1">&#39;Ta&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;Re&#39;</span><span class="p">,</span> <span class="s1">&#39;Os&#39;</span><span class="p">,</span> <span class="s1">&#39;Ir&#39;</span><span class="p">,</span> <span class="s1">&#39;Pt&#39;</span><span class="p">,</span> <span class="s1">&#39;Au&#39;</span><span class="p">,</span> <span class="s1">&#39;Hg&#39;</span><span class="p">,</span> <span class="s1">&#39;Tl&#39;</span><span class="p">,</span> <span class="s1">&#39;Pb&#39;</span><span class="p">,</span> <span class="s1">&#39;Bi&#39;</span><span class="p">]</span>


<span class="c1"># kroeger_core(e_data,a_data,eps_data,ee,thick, relativistic =True)</span>
<span class="c1"># kroeger_core2(e_data,a_data,eps_data,acceleration_voltage_kev,thickness, relativistic =True)</span>
<span class="c1"># get_wave_length(e0)</span>

<span class="c1"># plot_dispersion(plotdata, units, a_data, e_data, title, max_p, ee, ef = 4., ep= 16.8, Es = 0, IBT = [])</span>
<span class="c1"># drude(tags, e, ep, ew, tnm, eb)</span>
<span class="c1"># drude(ep, eb, gamma, e)</span>
<span class="c1"># drude_lorentz(epsInf,leng, ep, eb, gamma, e, Amplitude)</span>
<span class="c1"># zl_func( p,  x)</span>
<span class="c1"># ###############################################################</span>
<span class="c1"># Utility Functions</span>
<span class="c1"># ################################################################</span>

<div class="viewcode-block" id="get_wave_length"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.get_wave_length.html#pyTEMlib.eels_tools.get_wave_length">[docs]</a><span class="k">def</span> <span class="nf">get_wave_length</span><span class="p">(</span><span class="n">e0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get deBroglie wavelength of electron accelerated by energy (in eV) e0&quot;&quot;&quot;</span>

    <span class="n">ev</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">e</span> <span class="o">*</span> <span class="n">e0</span>
    <span class="k">return</span> <span class="n">constants</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">m_e</span> <span class="o">*</span> <span class="n">ev</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ev</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">m_e</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">c</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span></div>


<div class="viewcode-block" id="effective_collection_angle"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.effective_collection_angle.html#pyTEMlib.eels_tools.effective_collection_angle">[docs]</a><span class="k">def</span> <span class="nf">effective_collection_angle</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">beam_kv</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the effective collection angle in mrad:</span>

<span class="sd">    Translate from original Fortran program</span>
<span class="sd">    Calculates the effective collection angle in mrad:</span>
<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    energy_scale: numpy array</span>
<span class="sd">        first and last energy loss of spectrum in eV</span>
<span class="sd">    alpha: float</span>
<span class="sd">        convergence angle in mrad</span>
<span class="sd">    beta: float</span>
<span class="sd">        collection  angle in mrad</span>
<span class="sd">    beamKV: float</span>
<span class="sd">        acceleration voltage in V</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    eff_beta: float</span>
<span class="sd">        effective collection angle in mrad</span>

<span class="sd">    # function y = effbeta(ene,  alpha, beta, beam_kv)</span>
<span class="sd">    #</span>
<span class="sd">    #       This program computes etha(alpha,beta), that is the collection</span>
<span class="sd">    #       efficiency associated to the following geometry :</span>
<span class="sd">    #</span>
<span class="sd">    #       alpha = half angle of illumination  (0 -&gt; pi/2)</span>
<span class="sd">    #       beta  = half angle of collection    (0 -&gt; pi/2)</span>
<span class="sd">    #                                           (pi/2 = 1570.795 mrad)</span>
<span class="sd">    #</span>
<span class="sd">    #           A constant angular distribution of incident electrons is assumed</span>
<span class="sd">    #       for any incident angle (-alpha,alpha). These electrons imping the</span>
<span class="sd">    #       target and a single energy-loss event occurs, with a characteristic</span>
<span class="sd">    #       angle theta-e (relativistic). The angular distribution of the</span>
<span class="sd">    #       electrons after the target is analytically derived.</span>
<span class="sd">    #           This program integrates this distribution from theta=0 up to</span>
<span class="sd">    #       theta=beta with an adjustable angular step.</span>
<span class="sd">    #           This program also computes beta* which is the theoretical</span>
<span class="sd">    #       collection angle which would give the same value of etha(alpha,beta)</span>
<span class="sd">    #       with a parallel incident beam.</span>
<span class="sd">    #</span>
<span class="sd">    #       subroutines and function subprograms required</span>
<span class="sd">    #       ---------------------------------------------</span>
<span class="sd">    #       none</span>
<span class="sd">    #</span>
<span class="sd">    #       comments</span>
<span class="sd">    #       --------</span>
<span class="sd">    #</span>
<span class="sd">    #       The following parameters are asked as input :</span>
<span class="sd">    #        accelerating voltage (kV), energy loss range (eV) for the study,</span>
<span class="sd">    #        energy loss step (eV) in this range, alpha (mrad), beta (mrad).</span>
<span class="sd">    #       The program returns for each energy loss step :</span>
<span class="sd">    #        alpha (mrad), beta (mrad), theta-e (relativistic) (mrad),</span>
<span class="sd">    #        energy loss (eV), etha (#), beta * (mrad)</span>
<span class="sd">    #</span>
<span class="sd">    #       author :</span>
<span class="sd">    #       --------</span>
<span class="sd">    #       Pierre TREBBIA</span>
<span class="sd">    #       US 41 : &quot;Microscopie Electronique Analytique Quantitative&quot;</span>
<span class="sd">    #       Laboratoire de Physique des Solides, Bat. 510</span>
<span class="sd">    #       Universite Paris-Sud, F91405 ORSAY Cedex</span>
<span class="sd">    #       Phone : (33-1) 69 41 53 68</span>
<span class="sd">    #</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">beam_kv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">beam_kv</span> <span class="o">=</span> <span class="mf">100.0</span>

    <span class="k">if</span> <span class="n">alpha</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">beta</span>

    <span class="k">if</span> <span class="n">beta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">alpha</span>

    <span class="n">z1</span> <span class="o">=</span> <span class="n">beam_kv</span>  <span class="c1"># eV</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">z3</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">z4</span> <span class="o">=</span> <span class="mf">100.0</span>

    <span class="n">z5</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mf">0.001</span>  <span class="c1"># rad</span>
    <span class="n">z6</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="mf">0.001</span>  <span class="c1"># rad</span>
    <span class="n">z7</span> <span class="o">=</span> <span class="mf">500.0</span>  <span class="c1"># number of integration steps to be modified at will</span>

    <span class="c1">#       main loop on energy loss</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">zx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">z3</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">z4</span><span class="p">)):</span>  <span class="c1"># ! zx = current energy loss</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">zx</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span> <span class="o">+</span> <span class="mf">511060.</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">z1</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span> <span class="o">+</span> <span class="mf">1022120.</span><span class="p">))</span>  <span class="c1"># x0 = relativistic theta-e</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">z5</span> <span class="o">*</span> <span class="n">z5</span>
        <span class="n">x3</span> <span class="o">=</span> <span class="n">z5</span> <span class="o">/</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">z5</span> <span class="o">/</span> <span class="n">x0</span>
        <span class="n">x4</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
        <span class="n">dtheta</span> <span class="o">=</span> <span class="p">(</span><span class="n">z6</span> <span class="o">-</span> <span class="n">x4</span><span class="p">)</span> <span class="o">/</span> <span class="n">z7</span>
    <span class="c1">#</span>
    <span class="c1">#        calculation of the analytical expression</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">zi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">z7</span><span class="p">)):</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">x4</span> <span class="o">+</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">zi</span><span class="p">)</span>
        <span class="n">x5</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">theta</span>
        <span class="n">x6</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">x5</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">x0</span>
        <span class="n">x7</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x5</span>
        <span class="n">x8</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x7</span> <span class="o">*</span> <span class="n">x7</span> <span class="o">+</span> <span class="n">x6</span><span class="p">)</span>
        <span class="n">x9</span> <span class="o">=</span> <span class="p">(</span><span class="n">x8</span> <span class="o">+</span> <span class="n">x7</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">x10</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x9</span><span class="p">)</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">+</span> <span class="n">x10</span>

    <span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">/</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">x3</span><span class="p">)</span>  <span class="c1"># addition of the central contribution</span>
    <span class="n">x4</span> <span class="o">=</span> <span class="n">z5</span> <span class="o">*</span> <span class="n">z5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">x1</span><span class="p">)</span>  <span class="c1"># normalisation</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">/</span> <span class="n">x4</span>
    <span class="c1">#</span>
    <span class="c1">#        correction by geometrical factor (beta/alpha)**2</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">z6</span> <span class="o">&lt;</span> <span class="n">z5</span><span class="p">:</span>
        <span class="n">x5</span> <span class="o">=</span> <span class="n">z5</span> <span class="o">/</span> <span class="n">z6</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">x5</span> <span class="o">*</span> <span class="n">x5</span>

    <span class="n">etha2</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">*</span> <span class="mf">100.</span>
    <span class="c1">#</span>
    <span class="c1">#        calculation of beta *</span>
    <span class="c1">#</span>
    <span class="n">x6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">x1</span><span class="p">),</span> <span class="n">eta</span><span class="p">)</span>
    <span class="n">x7</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x6</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">x7</span> <span class="o">*</span> <span class="mf">1000.</span>  <span class="c1"># in mrad</span>

    <span class="k">return</span> <span class="n">beta</span></div>


<div class="viewcode-block" id="set_default_metadata"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.set_default_metadata.html#pyTEMlib.eels_tools.set_default_metadata">[docs]</a><span class="k">def</span> <span class="nf">set_default_metadata</span><span class="p">(</span><span class="n">current_dataset</span><span class="p">:</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="k">if</span> <span class="s1">&#39;experiment&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
        <span class="n">current_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;convergence_angle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]:</span>
        <span class="n">current_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;convergence_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="k">if</span> <span class="s1">&#39;collection_angle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]:</span>
        <span class="n">current_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;collection_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">if</span> <span class="s1">&#39;acceleration_voltage&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]:</span>
        <span class="n">current_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">][</span><span class="s1">&#39;acceleration_voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200000</span></div>

<span class="c1">###</span>

<span class="c1"># ###############################################################</span>
<span class="c1"># Peak Fit Functions</span>
<span class="c1"># ################################################################</span>


<div class="viewcode-block" id="residuals_smooth"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.residuals_smooth.html#pyTEMlib.eels_tools.residuals_smooth">[docs]</a><span class="k">def</span> <span class="nf">residuals_smooth</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">only_positive_intensity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;part of fit&quot;&quot;&quot;</span>

    <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">model_smooth</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">only_positive_intensity</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">err</span></div>


<div class="viewcode-block" id="model_smooth"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.model_smooth.html#pyTEMlib.eels_tools.model_smooth">[docs]</a><span class="k">def</span> <span class="nf">model_smooth</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">only_positive_intensity</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;part of fit&quot;&quot;&quot;</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">number_of_peaks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_peaks</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">only_positive_intensity</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mf">4.29193</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mf">4.29193</span> <span class="o">/</span> <span class="mf">2.</span>  <span class="c1"># ## width cannot extend beyond zero, maximum is FWTM/2</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">:])</span>

    <span class="k">return</span> <span class="n">y</span></div>


<div class="viewcode-block" id="gauss"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.gauss.html#pyTEMlib.eels_tools.gauss">[docs]</a><span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>  <span class="c1"># p[0]==mean, p[1]= amplitude p[2]==fwhm,</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian Function</span>

<span class="sd">        p[0]==mean, p[1]= amplitude p[2]==fwhm</span>
<span class="sd">        area = np.sqrt(2* np.pi)* p[1] * np.abs(p[2] / 2.3548)</span>
<span class="sd">        FWHM = 2 * np.sqrt(2 np.log(2)) * sigma = 2.3548 * sigma</span>
<span class="sd">        sigma = FWHM/3548</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.3548</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span></div>


<div class="viewcode-block" id="lorentz"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.lorentz.html#pyTEMlib.eels_tools.lorentz">[docs]</a><span class="k">def</span> <span class="nf">lorentz</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Lorentzian Function &quot;&quot;&quot;</span>
    <span class="n">lorentz_peak</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">lorentz_peak</span> <span class="o">/</span> <span class="n">lorentz_peak</span><span class="o">.</span><span class="n">max</span><span class="p">()</span></div>


<div class="viewcode-block" id="zl_func"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.zl_func.html#pyTEMlib.eels_tools.zl_func">[docs]</a><span class="k">def</span> <span class="nf">zl_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center1</span><span class="p">,</span> <span class="n">amplitude1</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="n">center2</span><span class="p">,</span> <span class="n">amplitude2</span><span class="p">,</span> <span class="n">width2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; zero loss function as product of two lorentzians &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lorentz</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center1</span><span class="p">,</span> <span class="n">amplitude1</span><span class="p">,</span> <span class="n">width1</span><span class="p">)</span> <span class="o">*</span> <span class="n">lorentz</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center2</span><span class="p">,</span> <span class="n">amplitude2</span><span class="p">,</span> <span class="n">width2</span><span class="p">)</span></div>


<div class="viewcode-block" id="zl"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.zl.html#pyTEMlib.eels_tools.zl">[docs]</a><span class="k">def</span> <span class="nf">zl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p_zl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;zero-loss function&quot;&quot;&quot;</span>
    <span class="n">p_zl_local</span> <span class="o">=</span> <span class="n">p_zl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">p_zl_local</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">p_zl_local</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">zero_loss</span> <span class="o">=</span> <span class="n">zl_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p_zl_local</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">zero_loss</span> <span class="o">/</span> <span class="n">zero_loss</span><span class="o">.</span><span class="n">max</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_channel_zero"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.get_channel_zero.html#pyTEMlib.eels_tools.get_channel_zero">[docs]</a><span class="k">def</span> <span class="nf">get_channel_zero</span><span class="p">(</span><span class="n">spectrum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">energy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determin shift of energy scale according to zero-loss peak position</span>
<span class="sd">    </span>
<span class="sd">    This function assumes that the zero loss peak is the maximum of the spectrum. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">zero</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">spectrum</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum</span><span class="p">),</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">width</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">zero</span><span class="o">+</span><span class="n">width</span><span class="p">)])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">width</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">zero</span><span class="o">+</span><span class="n">width</span><span class="p">)])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e-12</span>

    <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">energy</span><span class="p">[</span><span class="n">zero</span><span class="p">],</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">.5</span><span class="p">]</span>  <span class="c1"># Initial guess is a normal distribution</span>

    <span class="k">def</span> <span class="nf">errfunc</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">gauss</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span> <span class="o">-</span> <span class="n">yy</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>  <span class="c1"># Distance to the target function</span>
    
    <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">errfunc</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p0</span><span class="p">[:]),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="n">fit_mu</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">fwhm</span> <span class="o">=</span> <span class="n">p1</span>

    <span class="k">return</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">fit_mu</span></div>


<div class="viewcode-block" id="get_zero_loss_energy"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.get_zero_loss_energy.html#pyTEMlib.eels_tools.get_zero_loss_energy">[docs]</a><span class="k">def</span> <span class="nf">get_zero_loss_energy</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>

    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="n">startx</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">spectrum</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum</span><span class="p">),</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">startx</span> <span class="o">+</span> <span class="mi">3</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">startx</span> <span class="o">-</span> <span class="mi">3</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">startx</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">startx</span><span class="p">]:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">startx</span> <span class="o">-</span> <span class="n">i</span>
        <span class="k">if</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">startx</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">startx</span><span class="p">]:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">startx</span> <span class="o">+</span> <span class="n">i</span>
    <span class="k">if</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">startx</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">startx</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">energy</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># single spectrum</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">shifts</span> <span class="o">=</span> <span class="n">get_channel_zero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">energy</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shifts</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># line scan</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">shifts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_channel_zero</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:],</span> <span class="n">energy</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># spectral image</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">shifts</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_channel_zero</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">:],</span> <span class="n">energy</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shifts</span></div>


<div class="viewcode-block" id="shift_energy"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.shift_energy.html#pyTEMlib.eels_tools.shift_energy">[docs]</a><span class="k">def</span> <span class="nf">shift_energy</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">shifts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Align zero-loss peaks of any spectral sidpy dataset &quot;&quot;&quot;</span>

    <span class="n">new_si</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_si</span> <span class="o">*=</span> <span class="mf">0.0</span>

    <span class="n">image_dims</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_image_dims</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">image_dims</span> <span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_dims</span><span class="p">)</span> <span class="o">!=</span> <span class="n">shifts</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;array of energy shifts have to have same dimension as dataset&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;This function needs a sidpy Dataset to shift energy scale&#39;</span><span class="p">)</span>
    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># single spectrum</span>
        <span class="n">tck</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy_scale</span> <span class="o">-</span> <span class="n">shifts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">new_si</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">new_si</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;Spectrum&#39;</span>
    <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># line scan</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">tck</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy_scale</span> <span class="o">-</span> <span class="n">shifts</span><span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">new_si</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># spectral image</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">tck</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy_scale</span> <span class="o">-</span> <span class="n">shifts</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">new_si</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_si</span></div>


<div class="viewcode-block" id="align_zero_loss"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.align_zero_loss.html#pyTEMlib.eels_tools.align_zero_loss">[docs]</a><span class="k">def</span> <span class="nf">align_zero_loss</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>

    <span class="n">shifts</span> <span class="o">=</span> <span class="n">get_zero_loss_energy</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
    <span class="n">new_si</span> <span class="o">=</span> <span class="n">shift_energy</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">shifts</span><span class="p">)</span>    
    <span class="n">new_si</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;zero_loss&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;shifted&#39;</span><span class="p">:</span> <span class="n">shifts</span><span class="p">}})</span>
    <span class="k">return</span> <span class="n">new_si</span></div>


<div class="viewcode-block" id="get_resolution_functions"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.get_resolution_functions.html#pyTEMlib.eels_tools.get_resolution_functions">[docs]</a><span class="k">def</span> <span class="nf">get_resolution_functions</span><span class="p">(</span><span class="n">dset</span><span class="p">:</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">startFitEnergy</span><span class="p">:</span> <span class="nb">float</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">endFitEnergy</span><span class="p">:</span> <span class="nb">float</span><span class="o">=+</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">n_workers</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_threads</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze and fit low-loss EELS data within a specified energy range to determine zero-loss peaks.</span>

<span class="sd">    This function processes a low-loss EELS dataset from transmission electron microscopy (TEM) data, </span>
<span class="sd">    focusing on a specified energy range for analyzing and fitting the spectrum. </span>
<span class="sd">    It determines fitting parameters and applies these to extract zero-loss peak information </span>
<span class="sd">    from the dataset. The function handles both 2D and 3D datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        dset: sidpy.Dataset</span>
<span class="sd">            The dataset containing TEM spectral data.</span>
<span class="sd">        startFitEnergy: float</span>
<span class="sd">            The start energy of the fitting window.</span>
<span class="sd">        endFitEnergy: float</span>
<span class="sd">            The end energy of the fitting window.</span>
<span class="sd">        n_workers: int, optional</span>
<span class="sd">            The number of workers for parallel processing (default is 1).</span>
<span class="sd">        n_threads: int, optional</span>
<span class="sd">            The number of threads for parallel processing (default is 8).</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing:</span>
<span class="sd">            - z_loss_dset (sidpy.Dataset): The dataset with added zero-loss peak information.</span>
<span class="sd">            - z_loss_params (numpy.ndarray): Array of parameters used for the zero-loss peak fitting.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the input dataset does not have the expected dimensions or format.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - The function expects `dset` to have specific dimensionalities and will raise an error if they are not met.</span>
<span class="sd">        - Parallel processing is employed to enhance performance, particularly for large datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">start_fit_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">startFitEnergy</span><span class="p">)</span>
    <span class="n">end_fit_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">endFitEnergy</span><span class="p">)</span>
    <span class="n">guess_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">endFitEnergy</span> <span class="o">-</span> <span class="n">startFitEnergy</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    
    <span class="k">def</span> <span class="nf">get_good_guess</span><span class="p">(</span><span class="n">zl_func</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">):</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">zl_func</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span>
                               <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">guess_amplitude</span><span class="p">,</span> <span class="n">guess_width</span><span class="p">,</span>
                                   <span class="mi">0</span><span class="p">,</span> <span class="n">guess_amplitude</span><span class="p">,</span> <span class="n">guess_width</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">popt</span>

    <span class="n">fit_energy</span> <span class="o">=</span> <span class="n">energy</span><span class="p">[</span><span class="n">start_fit_pixel</span><span class="p">:</span><span class="n">end_fit_pixel</span><span class="p">]</span>
    <span class="c1"># get a good guess for the fit parameters</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">fit_dset</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">start_fit_pixel</span><span class="p">:</span><span class="n">end_fit_pixel</span><span class="p">]</span>
        <span class="n">guess_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fit_dset</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">guess_params</span> <span class="o">=</span> <span class="n">get_good_guess</span><span class="p">(</span><span class="n">zl_func</span><span class="p">,</span> <span class="n">fit_energy</span><span class="p">,</span> <span class="n">fit_dset</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">fit_dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">fit_dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">fit_dset</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[:,</span> <span class="n">start_fit_pixel</span><span class="p">:</span><span class="n">end_fit_pixel</span><span class="p">]</span>
        <span class="n">fit_energy</span> <span class="o">=</span> <span class="n">energy</span><span class="p">[</span><span class="n">start_fit_pixel</span><span class="p">:</span><span class="n">end_fit_pixel</span><span class="p">]</span>
        <span class="n">guess_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fit_dset</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">guess_params</span> <span class="o">=</span> <span class="n">get_good_guess</span><span class="p">(</span><span class="n">zl_func</span><span class="p">,</span> <span class="n">fit_energy</span><span class="p">,</span> <span class="n">fit_dset</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">fit_dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fit_dset</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="n">start_fit_pixel</span><span class="p">:</span><span class="n">end_fit_pixel</span><span class="p">]</span>
        <span class="n">fit_energy</span> <span class="o">=</span> <span class="n">energy</span><span class="p">[</span><span class="n">start_fit_pixel</span><span class="p">:</span><span class="n">end_fit_pixel</span><span class="p">]</span>
        <span class="n">guess_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fit_dset</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">guess_params</span> <span class="o">=</span> <span class="n">get_good_guess</span><span class="p">(</span><span class="n">zl_func</span><span class="p">,</span> <span class="n">fit_energy</span><span class="p">,</span> <span class="n">fit_dset</span><span class="p">)</span>
        <span class="n">z_loss_dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">z_loss_dset</span> <span class="o">*=</span> <span class="mf">0.0</span>
        <span class="n">z_loss_dset</span> <span class="o">+=</span> <span class="n">zl_func</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="o">*</span><span class="n">guess_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;zero_loss&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">z_loss_dset</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="n">z_loss_dset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;zero_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">z_loss_dset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;zero_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;startFitEnergy&#39;</span><span class="p">:</span> <span class="n">startFitEnergy</span><span class="p">,</span>
                                                  <span class="s1">&#39;endFitEnergy&#39;</span><span class="p">:</span> <span class="n">endFitEnergy</span><span class="p">,</span>
                                                  <span class="s1">&#39;fit_parameter&#39;</span><span class="p">:</span> <span class="n">guess_params</span><span class="p">,</span>
                                                  <span class="s1">&#39;original_low_loss&#39;</span><span class="p">:</span> <span class="n">dset</span><span class="o">.</span><span class="n">title</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">z_loss_dset</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: need a spectrum or spectral image sidpy dataset&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not dset.shape = &#39;</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># define guess function for SidFitter</span>
    <span class="k">def</span> <span class="nf">guess_function</span><span class="p">(</span><span class="n">xvec</span><span class="p">,</span> <span class="n">yvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">guess_params</span>
    
    <span class="c1"># apply to all spectra</span>
    <span class="n">zero_loss_fitter</span> <span class="o">=</span> <span class="n">SidFitter</span><span class="p">(</span><span class="n">fit_dset</span><span class="p">,</span> <span class="n">zl_func</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">n_workers</span><span class="p">,</span> <span class="n">guess_fn</span><span class="o">=</span><span class="n">guess_function</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">n_threads</span><span class="p">,</span>
                                 <span class="n">return_cov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">km_guess</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_fit_parms</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    
    <span class="p">[</span><span class="n">z_loss_params</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_loss_fitter</span><span class="o">.</span><span class="n">do_fit</span><span class="p">()</span>
    <span class="n">z_loss_dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">z_loss_dset</span> <span class="o">*=</span> <span class="mf">0.0</span>

    <span class="n">energy_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">energy</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="n">z_loss_dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                               <span class="n">z_loss_dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">energy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">z_loss_peaks</span> <span class="o">=</span> <span class="n">zl_func</span><span class="p">(</span><span class="n">energy_grid</span><span class="p">,</span> <span class="o">*</span><span class="n">z_loss_params</span><span class="p">)</span>
    <span class="n">z_loss_dset</span> <span class="o">+=</span> <span class="n">z_loss_peaks</span>

    <span class="n">shifts</span> <span class="o">=</span> <span class="n">z_loss_params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">z_loss_params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">widths</span> <span class="o">=</span> <span class="n">z_loss_params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">z_loss_params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">5</span><span class="p">]</span>

    <span class="n">z_loss_dset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;zero_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;startFitEnergy&#39;</span><span class="p">:</span> <span class="n">startFitEnergy</span><span class="p">,</span>
                                              <span class="s1">&#39;endFitEnergy&#39;</span><span class="p">:</span> <span class="n">endFitEnergy</span><span class="p">,</span>
                                              <span class="s1">&#39;fit_parameter&#39;</span><span class="p">:</span> <span class="n">z_loss_params</span><span class="p">,</span>
                                              <span class="s1">&#39;original_low_loss&#39;</span><span class="p">:</span> <span class="n">dset</span><span class="o">.</span><span class="n">title</span><span class="p">})</span>


    <span class="k">return</span> <span class="n">z_loss_dset</span></div>


<div class="viewcode-block" id="drude"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.drude.html#pyTEMlib.eels_tools.drude">[docs]</a><span class="k">def</span> <span class="nf">drude</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">peak_position</span><span class="p">,</span> <span class="n">peak_width</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dielectric function according to Drude theory&quot;&quot;&quot;</span>

    <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">peak_position</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">peak_width</span> <span class="o">*</span> <span class="n">energy_scale</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span>
           <span class="p">(</span><span class="n">energy_scale</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">energy_scale</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">))</span>  <span class="c1"># Mod drude term</span>
    <span class="k">return</span> <span class="n">eps</span></div>


<div class="viewcode-block" id="drude_lorentz"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.drude_lorentz.html#pyTEMlib.eels_tools.drude_lorentz">[docs]</a><span class="k">def</span> <span class="nf">drude_lorentz</span><span class="p">(</span><span class="n">eps_inf</span><span class="p">,</span> <span class="n">leng</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">eb</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dielectric function according to Drude-Lorentz theory&quot;&quot;&quot;</span>

    <span class="n">eps</span> <span class="o">=</span> <span class="n">eps_inf</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">leng</span><span class="p">):</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span> <span class="o">+</span> <span class="n">amplitude</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">ep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">eps</span></div>


<div class="viewcode-block" id="fit_plasmon"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.fit_plasmon.html#pyTEMlib.eels_tools.fit_plasmon">[docs]</a><span class="k">def</span> <span class="nf">fit_plasmon</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">startFitEnergy</span><span class="p">,</span> <span class="n">endFitEnergy</span><span class="p">,</span> <span class="n">plot_result</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">number_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">number_threads</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit plasmon peak positions and widths in a TEM dataset using a Drude model.</span>

<span class="sd">    This function applies the Drude model to fit plasmon peaks in a dataset obtained </span>
<span class="sd">    from transmission electron microscopy (TEM). It processes the dataset to determine </span>
<span class="sd">    peak positions, widths, and amplitudes within a specified energy range. The function </span>
<span class="sd">    can handle datasets with different dimensions and offers parallel processing capabilities.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        dataset: sidpy.Dataset or numpy.ndarray</span>
<span class="sd">            The dataset containing TEM spectral data.</span>
<span class="sd">        startFitEnergy: float</span>
<span class="sd">            The start energy of the fitting window.</span>
<span class="sd">        endFitEnergy: float</span>
<span class="sd">            The end energy of the fitting window.</span>
<span class="sd">        plot_result: bool, optional</span>
<span class="sd">            If True, plots the fitting results (default is False).</span>
<span class="sd">        number_workers: int, optional</span>
<span class="sd">            The number of workers for parallel processing (default is 4).</span>
<span class="sd">        number_threads: int, optional</span>
<span class="sd">            The number of threads for parallel processing (default is 8).</span>

<span class="sd">    Returns:</span>
<span class="sd">        fitted_dataset: sidpy.Dataset or numpy.ndarray</span>
<span class="sd">            The dataset with fitted plasmon peak parameters. The dimensions and </span>
<span class="sd">            format depend on the input dataset.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the input dataset does not have the expected dimensions or format.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - The function uses the Drude model to fit plasmon peaks.</span>
<span class="sd">        - The fitting parameters are peak position (Ep), peak width (Ew), and amplitude (A).</span>
<span class="sd">        - If `plot_result` is True, the function plots Ep, Ew, and A as separate subplots.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># define Drude function for plasmon fitting</span>
    <span class="k">def</span> <span class="nf">energy_loss_function</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">Ep</span><span class="p">,</span> <span class="n">Ew</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="n">E</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Ep</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">E</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Ew</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">Ew</span> <span class="o">*</span> <span class="n">Ep</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="n">E</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Ew</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">elf</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span>
        <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">elf</span>

    <span class="c1"># define window for fitting</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">start_fit_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">startFitEnergy</span><span class="p">)</span>
    <span class="n">end_fit_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">endFitEnergy</span><span class="p">)</span>

    <span class="c1"># rechunk dataset</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">fit_dset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">start_fit_pixel</span><span class="p">:</span><span class="n">end_fit_pixel</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">fit_dset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[:,</span> <span class="n">start_fit_pixel</span><span class="p">:</span><span class="n">end_fit_pixel</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fit_dset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">start_fit_pixel</span><span class="p">:</span><span class="n">end_fit_pixel</span><span class="p">])</span>
        <span class="n">guess_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">fit_dset</span><span class="p">)</span>
        <span class="n">guess_amplitude</span> <span class="o">=</span> <span class="n">fit_dset</span><span class="p">[</span><span class="n">guess_pos</span><span class="p">]</span>
        <span class="n">guess_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">endFitEnergy</span> <span class="o">-</span> <span class="n">startFitEnergy</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">energy_loss_function</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span>
                               <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="n">guess_pos</span><span class="p">,</span> <span class="n">guess_width</span><span class="p">,</span> <span class="n">guess_amplitude</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">popt</span>
    
    <span class="c1"># if it can be parallelized:</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">SidFitter</span><span class="p">(</span><span class="n">fit_dset</span><span class="p">,</span> <span class="n">energy_loss_function</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">number_workers</span><span class="p">,</span>
                       <span class="n">threads</span><span class="o">=</span><span class="n">number_threads</span><span class="p">,</span> <span class="n">return_cov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">km_guess</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_fit_parms</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="p">[</span><span class="n">fitted_dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">do_fit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">plot_result</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fitted_dataset</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ep - Peak Position&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fitted_dataset</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ew - Peak Width&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fitted_dataset</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;A - Amplitude&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fitted_dataset</span></div>


<div class="viewcode-block" id="drude_simulation"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.drude_simulation.html#pyTEMlib.eels_tools.drude_simulation">[docs]</a><span class="k">def</span> <span class="nf">drude_simulation</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ew</span><span class="p">,</span> <span class="n">tnm</span><span class="p">,</span> <span class="n">eb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;probabilities of dielectric function eps relative to zero-loss integral (i0 = 1)</span>

<span class="sd">    Gives probabilities of dielectric function eps relative to zero-loss integral (i0 = 1) per eV</span>
<span class="sd">    Details in R.F.Egerton: EELS in the Electron Microscope, 3rd edition, Springer 2011</span>

<span class="sd">    # function drude(ep,ew,eb,epc,e0,beta,nn,tnm)</span>
<span class="sd">    # Given the plasmon energy (ep), plasmon fwhm (ew) and binding energy(eb),</span>
<span class="sd">    # this program generates:</span>
<span class="sd">    # EPS1, EPS2 from modified Eq. (3.40), ELF=Im(-1/EPS) from Eq. (3.42),</span>
<span class="sd">    # single scattering from Eq. (4.26) and SRFINT from Eq. (4.31)</span>
<span class="sd">    # The output is e, ssd into the file drude.ssd (for use in Flog etc.)</span>
<span class="sd">    # and e,eps1 ,eps2 into drude.eps (for use in Kroeger etc.)</span>
<span class="sd">    # Gives probabilities relative to zero-loss integral (i0 = 1) per eV</span>
<span class="sd">    # Details in R.F.Egerton: EELS in the Electron Microscope, 3rd edition, Springer 2011</span>
<span class="sd">    # Version 10.11.26</span>


<span class="sd">    b.7 drude Simulation of a Low-Loss Spectrum</span>
<span class="sd">    The program DRUDE calculates a single-scattering plasmon-loss spectrum for</span>
<span class="sd">    a specimen of a given thickness tnm (in nm), recorded with electrons of a</span>
<span class="sd">    specified incident energy e0 by a spectrometer that accepts scattering up to a</span>
<span class="sd">    specified collection semi-angle beta. It is based on the extended drude model</span>
<span class="sd">    (Section 3.3.2), with a volume energy-loss function elf in accord with Eq. (3.64) and</span>
<span class="sd">    a surface-scattering energy-loss function srelf as in Eq. (4.31). Retardation effects</span>
<span class="sd">    and coupling between the two surface modes are not included. The surface term can</span>
<span class="sd">    be made negligible by entering a large specimen thickness (tnm &gt; 1000).</span>
<span class="sd">    Surface intensity srfint and volume intensity volint are calculated from</span>
<span class="sd">    Eqs. (4.31) and (4.26), respectively. The total spectral intensity ssd is written to</span>
<span class="sd">    the file DRUDE.SSD, which can be used as input for KRAKRO. These intensities are</span>
<span class="sd">    all divided by i0, to give relative probabilities (per eV). The real and imaginary parts</span>
<span class="sd">    of the dielectric function are written to DRUDE.EPS and can be used for comparison</span>
<span class="sd">    with the results of Kramers–Kronig analysis (KRAKRO.DAT).</span>
<span class="sd">    Written output includes the surface-loss probability Ps, obtained by integrating</span>
<span class="sd">    srfint (a value that relates to two surfaces but includes the negative begrenzungs</span>
<span class="sd">    term), for comparison with the analytical integration represented by Eq. (3.77). The</span>
<span class="sd">    volume-loss probability p_v is obtained by integrating volint and is used to calculate</span>
<span class="sd">    the volume plasmon mean free path (lam = tnm/p_v). The latter is listed and</span>
<span class="sd">    compared with the MFP obtained from Eq. (3.44), which represents analytical integration</span>
<span class="sd">    assuming a zero-width plasmon peak. The total probability (Pt = p_v+Ps) is</span>
<span class="sd">    calculated and used to evaluate the thickness (lam.Pt) that would be given by the formula</span>
<span class="sd">    t/λ = ln(It/i0), ignoring the surface-loss probability. Note that p_v will exceed</span>
<span class="sd">    1 for thicker specimens (t/λ &gt; 1), since it represents the probability of plasmon</span>
<span class="sd">    scattering relative to that of no inelastic scattering.</span>
<span class="sd">    The command-line usage is drude(ep,ew,eb,epc,beta,e0,tnm,nn), where ep is the</span>
<span class="sd">    plasmon energy, ew the plasmon width, eb the binding energy of the electrons (0 for</span>
<span class="sd">    a metal), and nn is the number of channels in the output spectrum. An example of</span>
<span class="sd">    the output is shown in Fig. b.1a,b.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">epc</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">energy_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dset</span><span class="o">.</span><span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># input(&#39;ev per channel : &#39;);</span>
    
    <span class="n">b</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;collection_angle&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.</span>  <span class="c1"># rad</span>
    <span class="n">epc</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">energy_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dset</span><span class="o">.</span><span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># input(&#39;ev per channel : &#39;);</span>
    <span class="n">e0</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;acceleration_voltage&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.</span>  <span class="c1"># input(&#39;incident energy e0(kev) : &#39;);</span>

    <span class="c1"># effective kinetic energy: T = m_o v^2/2,</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">e0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">e0</span> <span class="o">/</span> <span class="mf">1022.12</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">e0</span> <span class="o">/</span> <span class="mf">511.06</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># eV # equ.5.2a or Appendix E p 427</span>
    
    <span class="c1"># 2 gamma T</span>
    <span class="n">tgt</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">e0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1022.12</span> <span class="o">+</span> <span class="n">e0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">511.06</span> <span class="o">+</span> <span class="n">e0</span><span class="p">)</span>  <span class="c1"># eV  Appendix E p 427</span>
    
    <span class="n">rk0</span> <span class="o">=</span> <span class="mi">2590</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">e0</span> <span class="o">/</span> <span class="mf">511.06</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="mi">511060</span><span class="p">)</span>
    
    <span class="n">os</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ew_mod</span> <span class="o">=</span> <span class="n">eb</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">metadata</span>
   
    <span class="n">eps</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ep</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">ew_mod</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">ew</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span>  <span class="c1"># Mod drude term</span>
    
    <span class="n">eps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">eps</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e-19</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">eps</span><span class="p">)</span>

    <span class="n">the</span> <span class="o">=</span> <span class="n">e</span> <span class="o">/</span> <span class="n">tgt</span>  <span class="c1"># varies with energy loss! # Appendix E p 427</span>
    <span class="c1"># srfelf = 4..*eps2./((1+eps1).^2+eps2.^2) - elf; %equivalent</span>
    <span class="n">srfelf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="o">-</span><span class="mf">4.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">eps</span><span class="p">))</span> <span class="o">-</span> <span class="n">elf</span>  <span class="c1"># for 2 surfaces</span>
    <span class="n">angdep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="n">the</span><span class="p">)</span> <span class="o">/</span> <span class="n">the</span> <span class="o">-</span> <span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">the</span> <span class="o">*</span> <span class="n">the</span><span class="p">)</span>
    <span class="n">srfint</span> <span class="o">=</span> <span class="n">angdep</span> <span class="o">*</span> <span class="n">srfelf</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.1416</span> <span class="o">*</span> <span class="mf">0.05292</span> <span class="o">*</span> <span class="n">rk0</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>  <span class="c1"># probability per eV</span>
    <span class="n">anglog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">the</span> <span class="o">/</span> <span class="n">the</span><span class="p">)</span>
    <span class="n">i0</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># *tags[&#39;counts2e&#39;]</span>

    <span class="c1"># 2 * t = m_0 v**2 !!!  a_0 = 0.05292 nm</span>
    <span class="n">volint</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tnm</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">0.05292</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">elf</span> <span class="o">*</span> <span class="n">anglog</span><span class="p">)</span>  <span class="c1"># S equ 4.26% probability per eV</span>
    <span class="n">volint</span> <span class="o">=</span> <span class="n">volint</span> <span class="o">*</span> <span class="n">i0</span> <span class="o">/</span> <span class="n">epc</span>  <span class="c1"># S probability per channel</span>
    <span class="n">ssd</span> <span class="o">=</span> <span class="n">volint</span>  <span class="c1"># + srfint;</span>

    <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="o">-</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">epc</span><span class="p">))</span>

        <span class="n">ssd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">xs</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">volint</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">xs</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">srfint</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">xs</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># if os &lt;0:</span>
        <span class="n">p_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">srfint</span><span class="p">)</span>  <span class="c1"># 2 surfaces but includes negative Begrenzung contribution.</span>
        <span class="n">p_v</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">volint</span> <span class="o">/</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())))</span>  <span class="c1"># integrated volume probability</span>
        <span class="n">p_v</span> <span class="o">=</span> <span class="p">(</span><span class="n">volint</span> <span class="o">/</span> <span class="n">i0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># our data have he same epc and the trapez formula does not include</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="n">tnm</span> <span class="o">/</span> <span class="n">p_v</span>  <span class="c1"># does NOT depend on free-electron approximation (no damping).</span>
        <span class="n">lamfe</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="mf">0.05292</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="n">ep</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">tgt</span> <span class="o">/</span> <span class="n">ep</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Eq.(3.44) approximation</span>

        <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;eps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eps</span>
        <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;lam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lam</span>
        <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;lamfe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lamfe</span>
        <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;p_v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_v</span>

    <span class="k">return</span> <span class="n">ssd</span>  <span class="c1"># /np.pi</span></div>


<div class="viewcode-block" id="kroeger_core"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.kroeger_core.html#pyTEMlib.eels_tools.kroeger_core">[docs]</a><span class="k">def</span> <span class="nf">kroeger_core</span><span class="p">(</span><span class="n">e_data</span><span class="p">,</span> <span class="n">a_data</span><span class="p">,</span> <span class="n">eps_data</span><span class="p">,</span> <span class="n">acceleration_voltage_kev</span><span class="p">,</span> <span class="n">thickness</span><span class="p">,</span> <span class="n">relativistic</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function calculates the differential scattering probability</span>

<span class="sd">     .. math::</span>
<span class="sd">        \\frac{d^2P}{d \\Omega d_e}</span>
<span class="sd">    of the low-loss region for total loss and volume plasmon loss</span>

<span class="sd">    Args:</span>
<span class="sd">       e_data (array): energy scale [eV]</span>
<span class="sd">       a_data (array): angle or momentum range [rad]</span>
<span class="sd">       eps_data (array) dielectric function</span>
<span class="sd">       acceleration_voltage_kev (float): acceleration voltage [keV]</span>
<span class="sd">       thickness (float): thickness in nm</span>
<span class="sd">       relativistic (boolean): relativistic correction</span>

<span class="sd">    Returns:</span>
<span class="sd">       P (numpy array 2d): total loss probability</span>
<span class="sd">       p_vol (numpy array 2d): volume loss probability</span>

<span class="sd">       return P, P*scale*1e2,p_vol*1e2, p_simple*1e2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># $d^2P/(dEd\Omega) = \frac{1}{\pi^2 a_0 m_0 v^2} \Im \left[ \frac{t\mu^2}{\varepsilon \phi^2 } \right]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # Internally everything is calculated in si units</span>
<span class="sd">    # acceleration_voltage_kev = 200 #keV</span>
<span class="sd">    # thick = 32.0*10-9 # m</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a_data</span><span class="p">)</span>
    <span class="n">e_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e_data</span><span class="p">)</span>
    <span class="c1"># adjust input to si units</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">get_wave_length</span><span class="p">(</span><span class="n">acceleration_voltage_kev</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span>  <span class="c1"># in m</span>
    <span class="n">thickness</span> <span class="o">=</span> <span class="n">thickness</span> <span class="o">*</span> <span class="mf">1e-9</span>  <span class="c1"># input thickness now in m</span>

    <span class="c1"># Define constants</span>
    <span class="c1"># ec = 14.4;</span>
    <span class="n">m_0</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;electron mass&#39;</span><span class="p">)</span>  <span class="c1"># REST electron mass in kg</span>
    <span class="c1"># h = constants.Planck  # Planck&#39;s constant</span>
    <span class="n">hbar</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">hbar</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">speed_of_light</span>  <span class="c1"># speed of light m/s</span>
    <span class="n">bohr</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Bohr radius&#39;</span><span class="p">)</span>  <span class="c1"># Bohr radius in meters</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;elementary charge&#39;</span><span class="p">)</span>  <span class="c1"># electron charge in Coulomb</span>
    <span class="c1"># print(&#39;hbar =&#39;, hbar ,&#39; [Js] =&#39;, hbar/e ,&#39;[ eV s]&#39;)</span>

    <span class="c1"># Calculate fixed terms of equation</span>
    <span class="n">va</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">511.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">511.</span> <span class="o">+</span> <span class="n">acceleration_voltage_kev</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># acceleration_voltage_kev is incident energy in keV</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">va</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">relativistic</span><span class="p">:</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">c</span>  <span class="c1"># non-relativistic for =1</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># set = 1 to correspond to E+B &amp; Siegle</span>

    <span class="n">momentum</span> <span class="o">=</span> <span class="n">m_0</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">gamma</span>  <span class="c1"># used for xya, E&amp;B have no gamma</span>

    <span class="c1"># ##### Define mapped variables</span>

    <span class="c1"># Define independent variables E, theta</span>
    <span class="p">[</span><span class="n">energy</span><span class="p">,</span> <span class="n">theta</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">e_data</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="n">a_data</span><span class="p">)</span>
    <span class="c1"># Define CONJUGATE dielectric function variable eps</span>
    <span class="p">[</span><span class="n">eps</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">eps_data</span><span class="p">),</span> <span class="n">a_data</span><span class="p">)</span>

    <span class="c1"># ##### Calculate lambda in equation EB 2.3</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">1e-15</span>

    <span class="n">theta_e</span> <span class="o">=</span> <span class="n">energy</span> <span class="o">*</span> <span class="n">e</span> <span class="o">/</span> <span class="n">momentum</span> <span class="o">/</span> <span class="n">v</span>  <span class="c1"># critical angle</span>

    <span class="n">lambda2</span> <span class="o">=</span> <span class="n">theta2</span> <span class="o">-</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">theta_e</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Eq 2.3</span>

    <span class="n">lambd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lambda2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">lambd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; error negative lambda&#39;</span><span class="p">)</span>

    <span class="c1"># ##### Calculate lambda0 in equation EB 2.4</span>
    <span class="c1"># According to Kröger real(lambda0) is defined as positive!</span>

    <span class="n">phi2</span> <span class="o">=</span> <span class="n">lambda2</span> <span class="o">+</span> <span class="n">theta_e</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Eq. 2.2</span>
    <span class="n">lambda02</span> <span class="o">=</span> <span class="n">theta2</span> <span class="o">-</span> <span class="n">theta_e</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># eta=1 Eq 2.4</span>
    <span class="n">lambda02</span><span class="p">[</span><span class="n">lambda02</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lambda0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lambda02</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">lambda0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; error negative lambda0&#39;</span><span class="p">)</span>

    <span class="n">de</span> <span class="o">=</span> <span class="n">thickness</span> <span class="o">*</span> <span class="n">energy</span> <span class="o">*</span> <span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">hbar</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>  <span class="c1"># Eq 2.5</span>
    <span class="n">xya</span> <span class="o">=</span> <span class="n">lambd</span> <span class="o">*</span> <span class="n">de</span> <span class="o">/</span> <span class="n">theta_e</span>  <span class="c1"># used in Eqs 2.6, 2.7, 4.4</span>

    <span class="n">lplus</span> <span class="o">=</span> <span class="n">lambda0</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">+</span> <span class="n">lambd</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">xya</span><span class="p">)</span>  <span class="c1"># eta=1 %Eq 2.6</span>
    <span class="n">lminus</span> <span class="o">=</span> <span class="n">lambda0</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">+</span> <span class="n">lambd</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">xya</span><span class="p">)</span>  <span class="c1"># eta=1 %Eq 2.7</span>

    <span class="n">mue2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">eps</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Eq. 4.5</span>
    <span class="n">phi20</span> <span class="o">=</span> <span class="n">lambda02</span> <span class="o">+</span> <span class="n">theta_e</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Eq 4.6</span>
    <span class="n">phi201</span> <span class="o">=</span> <span class="n">theta2</span> <span class="o">+</span> <span class="n">theta_e</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">eps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># eta=1, eps-1 in E+b Eq.(4.7)</span>

    <span class="c1"># Eq 4.2</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">phi201</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">eps</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">lplus</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">lminus</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">a2</span>

    <span class="c1"># Eq 4.3</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lambda0</span> <span class="o">*</span> <span class="n">theta_e</span> <span class="o">*</span> <span class="n">phi201</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">lplus</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">lminus</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">de</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b1</span> <span class="o">*</span> <span class="n">b2</span>

    <span class="c1"># Eq 4.4</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">lambda0</span> <span class="o">*</span> <span class="n">lambd</span> <span class="o">*</span> <span class="n">theta_e</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">xya</span><span class="p">)</span> <span class="o">/</span> <span class="n">lplus</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">xya</span><span class="p">)</span> <span class="o">/</span> <span class="n">lminus</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">*</span> <span class="p">(</span><span class="n">c2</span> <span class="o">+</span> <span class="n">c3</span><span class="p">)</span>

    <span class="c1"># Put all the pieces together...</span>
    <span class="n">p_coef</span> <span class="o">=</span> <span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="n">bohr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m_0</span> <span class="o">*</span> <span class="n">v</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">p_v</span> <span class="o">=</span> <span class="n">thickness</span> <span class="o">*</span> <span class="n">mue2</span> <span class="o">/</span> <span class="n">eps</span> <span class="o">/</span> <span class="n">phi2</span>

    <span class="n">p_s1</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">theta2</span> <span class="o">*</span> <span class="p">(</span><span class="n">eps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">phi20</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">phi2</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># ASSUMES eta=1</span>
    <span class="n">p_s2</span> <span class="o">=</span> <span class="n">hbar</span> <span class="o">/</span> <span class="n">momentum</span>
    <span class="n">p_s3</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>

    <span class="n">p_s</span> <span class="o">=</span> <span class="n">p_s1</span> <span class="o">*</span> <span class="n">p_s2</span> <span class="o">*</span> <span class="n">p_s3</span>

    <span class="c1"># print(p_v.min(),p_v.max(),p_s.min(),p_s.max())</span>
    <span class="c1"># Calculate P and p_vol (volume only)</span>
    <span class="n">dtheta</span> <span class="o">=</span> <span class="n">a_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">a_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">*</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">p_coef</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">p_v</span> <span class="o">-</span> <span class="n">p_s</span><span class="p">)</span>  <span class="c1"># Eq 4.1</span>
    <span class="n">p_vol</span> <span class="o">=</span> <span class="n">p_coef</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">p_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>

    <span class="c1"># lplus_min = e_data[np.argmin(np.real(lplus), axis=1)]</span>
    <span class="c1"># lminus_min = e_data[np.argmin(np.imag(lminus), axis=1)]</span>

    <span class="n">p_simple</span> <span class="o">=</span> <span class="n">p_coef</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">thickness</span> <span class="o">/</span> <span class="p">(</span><span class="n">theta2</span> <span class="o">+</span> <span class="n">theta_e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="c1"># Watch it: eps is conjugated dielectric function</span>

    <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">*</span> <span class="mf">1e2</span><span class="p">,</span> <span class="n">p_vol</span> <span class="o">*</span> <span class="mf">1e2</span><span class="p">,</span> <span class="n">p_simple</span> <span class="o">*</span> <span class="mf">1e2</span>  <span class="c1"># ,lplus_min,lminus_min</span></div>


<span class="c1">#################################################################</span>
<span class="c1"># CORE - LOSS functions</span>
<span class="c1">#################################################################</span>

<div class="viewcode-block" id="get_z"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.get_z.html#pyTEMlib.eels_tools.get_z">[docs]</a><span class="k">def</span> <span class="nf">get_z</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the atomic number independent of input as a string or number</span>

<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    z: int, str</span>
<span class="sd">        atomic number of chemical symbol (0 if not valid)</span>
<span class="sd">    Return:</span>
<span class="sd">    ------</span>
<span class="sd">    z_out: int</span>
<span class="sd">        atomic number</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_sections</span> <span class="o">=</span> <span class="n">get_x_sections</span><span class="p">()</span>

    <span class="n">z_out</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">z_out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x_sections</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">z</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>  <span class="c1"># Well one really should know how to write elemental</span>
                <span class="n">z_out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;A string or number is required&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">z_out</span></div>


<div class="viewcode-block" id="get_x_sections"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.get_x_sections.html#pyTEMlib.eels_tools.get_x_sections">[docs]</a><span class="k">def</span> <span class="nf">get_x_sections</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads X-ray fluorescent cross-sections from a dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    z: int</span>
<span class="sd">        atomic number if zero all cross-sections will be returned</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dictionary</span>
<span class="sd">        cross-section of an element or of all elements if z = 0</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_sections</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x_sections</span><span class="p">[</span><span class="n">z</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="list_all_edges"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.list_all_edges.html#pyTEMlib.eels_tools.list_all_edges">[docs]</a><span class="k">def</span> <span class="nf">list_all_edges</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">-&gt;</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all ionization edges of an element with atomic number z</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    z: int</span>
<span class="sd">        atomic number</span>
<span class="sd">    verbose: bool, optional</span>
<span class="sd">        more info if set to True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out_string: str</span>
<span class="sd">        string with all major edges in energy range</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">element</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_z</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
    <span class="n">x_sections</span> <span class="o">=</span> <span class="n">get_x_sections</span><span class="p">()</span>
    <span class="n">out_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Major edges&#39;</span><span class="p">)</span>
    <span class="n">edge_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="p">{}}</span>
    
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_edges</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;onset&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">8.1f</span><span class="si">}</span><span class="s2"> eV &quot;</span><span class="p">)</span>
                <span class="n">out_string</span> <span class="o">=</span> <span class="n">out_string</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: &quot;</span> \
                                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">8.1f</span><span class="si">}</span><span class="s2"> eV /n&quot;</span>
                <span class="n">edge_list</span><span class="p">[</span><span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out_string</span><span class="p">,</span> <span class="n">edge_list</span></div>


<div class="viewcode-block" id="find_all_edges"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.find_all_edges.html#pyTEMlib.eels_tools.find_all_edges">[docs]</a><span class="k">def</span> <span class="nf">find_all_edges</span><span class="p">(</span><span class="n">edge_onset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">maximal_chemical_shift</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">major_edges_only</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find all (major and minor) edges within an energy range</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    edge_onset: float</span>
<span class="sd">        approximate energy of ionization edge</span>
<span class="sd">    maximal_chemical_shift: float, default = 5eV</span>
<span class="sd">        range of energy window around edge_onset to look for major edges</span>
<span class="sd">    major_edges_only: boolean, default = False</span>
<span class="sd">        only major edges are considered if True</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    text: str</span>
<span class="sd">        string with all edges in energy range</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">x_sections</span> <span class="o">=</span> <span class="n">get_x_sections</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;onset&#39;</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">edge_onset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maximal_chemical_shift</span><span class="p">:</span>
                        <span class="c1"># print(element, x_sections[element][&#39;name&#39;], key, x_sections[element][key][&#39;onset&#39;])</span>
                        <span class="n">new_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">2s</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: &quot;</span> \
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_sections</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">8.1f</span><span class="si">}</span><span class="s2"> eV &quot;</span>
                        <span class="k">if</span> <span class="n">major_edges_only</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">major_edges</span><span class="p">:</span>
                                <span class="n">text</span> <span class="o">+=</span> <span class="n">new_text</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">text</span> <span class="o">+=</span> <span class="n">new_text</span>

    <span class="k">return</span> <span class="n">text</span></div>


<div class="viewcode-block" id="find_associated_edges"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.find_associated_edges.html#pyTEMlib.eels_tools.find_associated_edges">[docs]</a><span class="k">def</span> <span class="nf">find_associated_edges</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">onsets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;edges&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="s1">&#39;element&#39;</span><span class="p">]</span>
                <span class="n">pre_edge</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># edge[&#39;onset&#39;]-edge[&#39;start_exclude&#39;]</span>
                <span class="n">post_edge</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="s1">&#39;end_exclude&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">edge</span><span class="p">[</span><span class="s1">&#39;all_edges&#39;</span><span class="p">]:</span>  <span class="c1"># TODO: Could be replaced with exclude</span>
                    <span class="n">onsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="s1">&#39;all_edges&#39;</span><span class="p">][</span><span class="n">sym</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">edge</span><span class="p">[</span><span class="s1">&#39;chemical_shift&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">pre_edge</span><span class="p">)</span>
                    <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">onsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;peak_fit&#39;</span><span class="p">][</span><span class="s1">&#39;peaks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">onset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onsets</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">onset</span> <span class="o">&lt;</span> <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">onset</span><span class="o">+</span><span class="n">post_edge</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">onset</span><span class="p">):</span>
                            <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">onset</span><span class="p">)</span>  <span class="c1"># TODO: check whether absolute is good</span>
                            <span class="n">distance_onset</span> <span class="o">=</span> <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">onset</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">ii</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;associated_edge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># check if more info is necessary</span>
                    <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;distance_to_onset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_onset</span></div>


<div class="viewcode-block" id="find_white_lines"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.find_white_lines.html#pyTEMlib.eels_tools.find_white_lines">[docs]</a><span class="k">def</span> <span class="nf">find_white_lines</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;edges&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
        <span class="n">white_lines</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;peak_fit&#39;</span><span class="p">][</span><span class="s1">&#39;peaks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;associated_edge&#39;</span> <span class="ow">in</span> <span class="n">peak</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;associated_edge&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L3&#39;</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="s1">&#39;M5&#39;</span><span class="p">,</span> <span class="s1">&#39;M4&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;distance_to_onset&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">peak</span><span class="p">[</span><span class="s1">&#39;associated_edge&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">white_lines</span><span class="p">:</span>
                                <span class="n">white_lines</span><span class="p">[</span><span class="n">peak</span><span class="p">[</span><span class="s1">&#39;associated_edge&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
                            <span class="k">if</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">white_lines</span><span class="p">[</span><span class="n">peak</span><span class="p">[</span><span class="s1">&#39;associated_edge&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">area</span>  <span class="c1"># TODO: only positive ones?</span>
        <span class="n">white_line_ratios</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">white_line_sum</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">white_lines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sym</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="s1">&#39;M4&#39;</span><span class="p">,</span> <span class="s1">&#39;M2&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">area</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}{</span><span class="nb">int</span><span class="p">(</span><span class="n">sym</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">white_lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">white_lines</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}{</span><span class="nb">int</span><span class="p">(</span><span class="n">sym</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">white_line_ratios</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sym</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}{</span><span class="nb">int</span><span class="p">(</span><span class="n">sym</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span> <span class="o">/</span> <span class="n">white_lines</span><span class="p">[</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}{</span><span class="nb">int</span><span class="p">(</span><span class="n">sym</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                        <span class="n">white_line_sum</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="n">sym</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}{</span><span class="nb">int</span><span class="p">(</span><span class="n">sym</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">area</span> <span class="o">+</span> <span class="n">white_lines</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}{</span><span class="nb">int</span><span class="p">(</span><span class="n">sym</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>

                        <span class="n">areal_density</span> <span class="o">=</span> <span class="mf">1.</span>
                        <span class="k">if</span> <span class="s1">&#39;edges&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="s1">&#39;element&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sym</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                                        <span class="n">areal_density</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="s1">&#39;areal_density&#39;</span><span class="p">]</span>
                                        <span class="k">break</span>
                        <span class="n">white_line_sum</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="n">sym</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}{</span><span class="nb">int</span><span class="p">(</span><span class="n">sym</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">areal_density</span>

        <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;peak_fit&#39;</span><span class="p">][</span><span class="s1">&#39;white_lines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">white_lines</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;peak_fit&#39;</span><span class="p">][</span><span class="s1">&#39;white_line_ratios&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">white_line_ratios</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;peak_fit&#39;</span><span class="p">][</span><span class="s1">&#39;white_line_sums&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">white_line_sum</span></div>
        

<div class="viewcode-block" id="second_derivative"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.second_derivative.html#pyTEMlib.eels_tools.second_derivative">[docs]</a><span class="k">def</span> <span class="nf">second_derivative</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">sensitivity</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates second derivative of a sidpy.dataset&quot;&quot;&quot;</span>

    <span class="n">dim</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">()</span>
    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;SPECTRAL_IMAGE&#39;</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">get_spectrum</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">dispersion</span> <span class="o">=</span> <span class="n">get_slope</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">)</span>
    <span class="n">second_dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">spec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">+</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">second_dif</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">second_dif</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># find if there is a strong edge at high energy_scale</span>
    <span class="n">noise_level</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">second_dif</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">50</span><span class="p">])</span>
    <span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">second_dif</span><span class="p">,</span> <span class="n">noise_level</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">/</span> <span class="n">dispersion</span>
    <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">start_end_noise</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">)</span> <span class="o">-</span> <span class="n">width</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">start_end_noise</span><span class="p">:</span>
            <span class="n">start_end_noise</span> <span class="o">=</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">70</span>

    <span class="n">noise_level_start</span> <span class="o">=</span> <span class="n">sensitivity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">second_dif</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">50</span><span class="p">])</span>
    <span class="n">noise_level_end</span> <span class="o">=</span> <span class="n">sensitivity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">second_dif</span><span class="p">[</span><span class="n">start_end_noise</span><span class="p">:</span> <span class="n">start_end_noise</span> <span class="o">+</span> <span class="mi">50</span><span class="p">])</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">noise_level_end</span> <span class="o">-</span> <span class="n">noise_level_start</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">)</span> <span class="o">-</span> <span class="mi">400</span><span class="p">)</span>
    <span class="n">noise_level</span> <span class="o">=</span> <span class="n">noise_level_start</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">))</span> <span class="o">*</span> <span class="n">slope</span>
    <span class="k">return</span> <span class="n">second_dif</span><span class="p">,</span> <span class="n">noise_level</span></div>


<div class="viewcode-block" id="find_edges"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.find_edges.html#pyTEMlib.eels_tools.find_edges">[docs]</a><span class="k">def</span> <span class="nf">find_edges</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">sensitivity</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;find edges within a sidpy.Dataset&quot;&quot;&quot;</span>

    <span class="n">dim</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">()</span>
    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">second_dif</span><span class="p">,</span> <span class="n">noise_level</span> <span class="o">=</span> <span class="n">second_derivative</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">sensitivity</span><span class="o">=</span><span class="n">sensitivity</span><span class="p">)</span>

    <span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">peaks</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">second_dif</span><span class="p">,</span> <span class="n">noise_level</span><span class="p">)</span>

    <span class="n">peaks</span><span class="p">[</span><span class="s1">&#39;peak_positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">peaks</span><span class="p">[</span><span class="s1">&#39;peak_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span>
    <span class="n">edge_energies</span> <span class="o">=</span> <span class="p">[</span><span class="n">energy_scale</span><span class="p">[</span><span class="mi">50</span><span class="p">]]</span>
    <span class="n">edge_indices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="o">-</span><span class="n">second_dif</span><span class="p">,</span> <span class="n">noise_level</span><span class="p">)</span>
    <span class="n">minima</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">peak_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s1">&#39;peak_positions&#39;</span><span class="p">])):</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="s1">&#39;peak_positions&#39;</span><span class="p">][</span><span class="n">peak_number</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">position</span> <span class="o">-</span> <span class="n">edge_energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">impossible</span> <span class="o">=</span> <span class="n">minima</span><span class="p">[</span><span class="n">minima</span> <span class="o">&lt;</span> <span class="n">position</span><span class="p">]</span>
            <span class="n">impossible</span> <span class="o">=</span> <span class="n">impossible</span><span class="p">[</span><span class="n">impossible</span> <span class="o">&gt;</span> <span class="n">position</span> <span class="o">-</span> <span class="mi">5</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">impossible</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">possible</span> <span class="o">=</span> <span class="n">minima</span><span class="p">[</span><span class="n">minima</span> <span class="o">&gt;</span> <span class="n">position</span><span class="p">]</span>
                <span class="n">possible</span> <span class="o">=</span> <span class="n">possible</span><span class="p">[</span><span class="n">possible</span> <span class="o">&lt;</span> <span class="n">position</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">edge_energies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">position</span> <span class="o">+</span> <span class="n">possible</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">edge_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="n">possible</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">selected_edges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">edge_indices</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">525</span> <span class="o">&lt;</span> <span class="n">energy_scale</span><span class="p">[</span><span class="n">peak</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">533</span><span class="p">:</span>
            <span class="n">selected_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;O-K1&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_edge</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">find_all_edges</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">[</span><span class="n">peak</span><span class="p">],</span> <span class="mi">20</span><span class="p">,</span> <span class="n">major_edges_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">minimum_dist</span> <span class="o">=</span> <span class="mf">100.</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">energy</span> <span class="o">-</span> <span class="n">energy_scale</span><span class="p">[</span><span class="n">peak</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">minimum_dist</span><span class="p">:</span>
                    <span class="n">minimum_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">energy</span> <span class="o">-</span> <span class="n">energy_scale</span><span class="p">[</span><span class="n">peak</span><span class="p">])</span>
                    <span class="n">selected_edge</span> <span class="o">=</span> <span class="n">name</span>

            <span class="k">if</span> <span class="n">selected_edge</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">selected_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_edge</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">selected_edges</span></div>


<div class="viewcode-block" id="assign_likely_edges"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.assign_likely_edges.html#pyTEMlib.eels_tools.assign_likely_edges">[docs]</a><span class="k">def</span> <span class="nf">assign_likely_edges</span><span class="p">(</span><span class="n">edge_channels</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">energy_scale</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="n">edges_in_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">edge_channels</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edge_channels</span><span class="p">[</span><span class="n">edges_in_list</span><span class="p">]:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">element_list</span> <span class="o">=</span> <span class="n">find_all_edges</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">maximal_chemical_shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">major_edges_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">element_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shift</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="n">find_all_edges</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">maximal_chemical_shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">major_edges_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">element_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">shift</span><span class="o">-=</span><span class="mi">1</span>
                    <span class="n">element_list</span> <span class="o">=</span> <span class="n">find_all_edges</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">maximal_chemical_shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">major_edges_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="n">find_all_edges</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">maximal_chemical_shift</span><span class="o">=</span><span class="n">shift</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">major_edges_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">element</span> <span class="o">=</span> <span class="p">(</span><span class="n">element_list</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">get_z</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span><span class="p">[]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">edge_list</span> <span class="o">=</span> <span class="n">list_all_edges</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">edge_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edge_list</span><span class="p">[</span><span class="n">peak</span><span class="p">]:</span>
                    <span class="n">possible_minor_edge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">[</span><span class="n">edge_channels</span><span class="p">]</span><span class="o">-</span><span class="n">edge_list</span><span class="p">[</span><span class="n">peak</span><span class="p">][</span><span class="n">edge</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">[</span><span class="n">edge_channels</span><span class="p">[</span><span class="n">possible_minor_edge</span><span class="p">]]</span><span class="o">-</span><span class="n">edge_list</span><span class="p">[</span><span class="n">peak</span><span class="p">][</span><span class="n">edge</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="c1">#print(&#39;nex&#39;, next_e)</span>
                        <span class="n">edges_in_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">possible_minor_edge</span><span class="p">)</span>
                        
                        <span class="n">result</span><span class="p">[</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
                    
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="auto_id_edges"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.auto_id_edges.html#pyTEMlib.eels_tools.auto_id_edges">[docs]</a><span class="k">def</span> <span class="nf">auto_id_edges</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="n">edge_channels</span> <span class="o">=</span> <span class="n">identify_edges</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">()</span>
    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">found_edges</span> <span class="o">=</span> <span class="n">assign_likely_edges</span><span class="p">(</span><span class="n">edge_channels</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">found_edges</span></div>


<div class="viewcode-block" id="identify_edges"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.identify_edges.html#pyTEMlib.eels_tools.identify_edges">[docs]</a><span class="k">def</span> <span class="nf">identify_edges</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">noise_level</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Using first derivative to determine edge onsets</span>
<span class="sd">    Any peak in first derivative higher than noise_level times standard deviation will be considered</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset: sidpy.Dataset</span>
<span class="sd">        the spectrum</span>
<span class="sd">    noise_level: float</span>
<span class="sd">        ths number times standard deviation in first derivative decides on whether an edge onset is significant</span>
<span class="sd">        </span>
<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    edge_channel: numpy.ndarray</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">()</span>
    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">dispersion</span> <span class="o">=</span> <span class="n">get_slope</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">)</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="mi">3</span><span class="o">/</span><span class="n">dispersion</span><span class="p">)</span>  <span class="c1"># smooth with 3eV wideGaussian</span>

    <span class="n">first_derivative</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">+</span><span class="mi">2</span><span class="p">)</span> 
    <span class="n">first_derivative</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">first_derivative</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># find if there is a strong edge at high energy_scale</span>
    <span class="n">noise_level</span> <span class="o">=</span> <span class="n">noise_level</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">first_derivative</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">50</span><span class="p">])</span>
    <span class="p">[</span><span class="n">edge_channels</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">first_derivative</span><span class="p">,</span> <span class="n">noise_level</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">edge_channels</span></div>


<div class="viewcode-block" id="add_element_to_dataset"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.add_element_to_dataset.html#pyTEMlib.eels_tools.add_element_to_dataset">[docs]</a><span class="k">def</span> <span class="nf">add_element_to_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We check whether this element is already in the</span>
    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">zz</span> <span class="o">=</span> <span class="n">get_z</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;edges&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
         <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;use_low_loss&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">edge</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zz</span> <span class="o">==</span> <span class="n">edge</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">break</span>

    <span class="n">major_edge</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">minor_edge</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">all_edges</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">x_section</span> <span class="o">=</span> <span class="n">get_x_sections</span><span class="p">(</span><span class="n">zz</span><span class="p">)</span>
    <span class="n">edge_start</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># int(15./ft.get_slope(self.energy_scale)+0.5)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">x_section</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">energy_scale</span><span class="p">[</span><span class="n">edge_start</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_section</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">energy_scale</span><span class="p">[</span><span class="o">-</span><span class="n">edge_start</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;K1&#39;</span><span class="p">,</span> <span class="s1">&#39;L3&#39;</span><span class="p">,</span> <span class="s1">&#39;M5&#39;</span><span class="p">,</span> <span class="s1">&#39;M3&#39;</span><span class="p">]:</span>
                    <span class="n">major_edge</span> <span class="o">=</span> <span class="n">key</span>
                
                <span class="n">all_edges</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;onset&#39;</span><span class="p">:</span> <span class="n">x_section</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]}</span>

    <span class="k">if</span> <span class="n">major_edge</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">major_edge</span>
    <span class="k">elif</span> <span class="n">minor_edge</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">minor_edge</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find no edge of </span><span class="si">{</span><span class="n">zz</span><span class="si">}</span><span class="s1"> in spectrum&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]:</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">start_exclude</span> <span class="o">=</span> <span class="n">x_section</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_section</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;excl before&#39;</span><span class="p">]</span>
    <span class="n">end_exclude</span> <span class="o">=</span> <span class="n">x_section</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_section</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;excl after&#39;</span><span class="p">]</span>

    <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="n">zz</span><span class="p">,</span> <span class="s1">&#39;symmetry&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;element&#39;</span><span class="p">:</span> <span class="n">elements</span><span class="p">[</span><span class="n">zz</span><span class="p">],</span>
                              <span class="s1">&#39;onset&#39;</span><span class="p">:</span> <span class="n">x_section</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">],</span> <span class="s1">&#39;end_exclude&#39;</span><span class="p">:</span> <span class="n">end_exclude</span><span class="p">,</span>
                              <span class="s1">&#39;start_exclude&#39;</span><span class="p">:</span> <span class="n">start_exclude</span><span class="p">}</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)][</span><span class="s1">&#39;all_edges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_edges</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)][</span><span class="s1">&#39;chemical_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)][</span><span class="s1">&#39;areal_density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)][</span><span class="s1">&#39;original_onset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="make_edges"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.make_edges.html#pyTEMlib.eels_tools.make_edges">[docs]</a><span class="k">def</span> <span class="nf">make_edges</span><span class="p">(</span><span class="n">edges_present</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">e_0</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">coll_angle</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">low_loss</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Makes the edges dictionary for quantification</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    edges_present: list</span>
<span class="sd">        list of edges</span>
<span class="sd">    energy_scale: numpy array</span>
<span class="sd">        energy scale on which to make cross-section</span>
<span class="sd">    e_0: float</span>
<span class="sd">        acceleration voltage (in V)</span>
<span class="sd">    coll_angle: float</span>
<span class="sd">        collection angle in mrad</span>
<span class="sd">    low_loss: numpy array with same length as energy_scale</span>
<span class="sd">        low_less spectrum with which to convolve the cross-section (default=None)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    edges: dict</span>
<span class="sd">        dictionary with all information on cross-section</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_sections</span> <span class="o">=</span> <span class="n">get_x_sections</span><span class="p">()</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edges_present</span><span class="p">):</span>
        <span class="n">element</span><span class="p">,</span> <span class="n">symmetry</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="n">x_sections</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
        <span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symmetry</span>
        <span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="n">xsec</span> <span class="o">=</span> <span class="n">x_sections</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">])]</span>
        <span class="k">if</span> <span class="s1">&#39;chemical_shift&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;chemical_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;symmetry&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;K1&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;K&#39;</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;K1&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;L&#39;</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;L3&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;M&#39;</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;M5&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;original_onset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xsec</span><span class="p">[</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span>
        <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;original_onset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;chemical_shift&#39;</span><span class="p">]</span>
        <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_exclude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">xsec</span><span class="p">[</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]][</span><span class="s1">&#39;excl before&#39;</span><span class="p">]</span>
        <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;end_exclude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">xsec</span><span class="p">[</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]][</span><span class="s1">&#39;excl after&#39;</span><span class="p">]</span>

    <span class="n">edges</span> <span class="o">=</span> <span class="n">make_cross_sections</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="n">e_0</span><span class="p">,</span> <span class="n">coll_angle</span><span class="p">,</span> <span class="n">low_loss</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">edges</span></div>

<div class="viewcode-block" id="fit_dataset"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.fit_dataset.html#pyTEMlib.eels_tools.fit_dataset">[docs]</a><span class="k">def</span> <span class="nf">fit_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;fit_area&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]:</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="s1">&#39;fit_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;fit_start&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="s1">&#39;fit_area&#39;</span><span class="p">]:</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;fit_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;fit_end&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="s1">&#39;fit_area&#39;</span><span class="p">]:</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;fit_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="s1">&#39;use_low_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">if</span> <span class="s1">&#39;experiment&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;convergence_angle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;need a convergence_angle in experiment of metadata dictionary &#39;</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;convergence_angle&#39;</span><span class="p">]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;collection_angle&#39;</span><span class="p">]</span>
        <span class="n">beam_kv</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;acceleration_voltage&#39;</span><span class="p">]</span>
        <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">eff_beta</span> <span class="o">=</span> <span class="n">effective_collection_angle</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">beam_kv</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">make_cross_sections</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">),</span> <span class="n">beam_kv</span><span class="p">,</span> <span class="n">eff_beta</span><span class="p">)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_edges2</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span>
        <span class="n">areal_density</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>  <span class="c1"># only edges have numbers in that dictionary</span>
                <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">])</span>
                <span class="n">areal_density</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;areal_density&#39;</span><span class="p">])</span>
        <span class="n">areal_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">areal_density</span><span class="p">)</span>
        <span class="n">out_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Relative composition: </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elements</span><span class="p">):</span>
            <span class="n">out_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">areal_density</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">areal_density</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%  &#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">out_string</span><span class="p">)</span></div>


<div class="viewcode-block" id="auto_chemical_composition"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.auto_chemical_composition.html#pyTEMlib.eels_tools.auto_chemical_composition">[docs]</a><span class="k">def</span> <span class="nf">auto_chemical_composition</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span><span class="n">sidpy</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>

    <span class="n">found_edges</span> <span class="o">=</span> <span class="n">auto_id_edges</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">found_edges</span><span class="p">:</span>
        <span class="n">add_element_to_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="n">fit_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_cross_sections"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.make_cross_sections.html#pyTEMlib.eels_tools.make_cross_sections">[docs]</a><span class="k">def</span> <span class="nf">make_cross_sections</span><span class="p">(</span><span class="n">edges</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">e_0</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">coll_angle</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">low_loss</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Updates the edges dictionary with collection angle-integrated X-ray photo-absorption cross-sections</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xsec_xrpa</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">e_0</span> <span class="o">/</span> <span class="mf">1000.</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">coll_angle</span><span class="p">,</span>
                                           <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;chemical_shift&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e10</span>  <span class="c1"># from barnes to 1/nm^2</span>
            <span class="k">if</span> <span class="n">low_loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">low_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">low_loss</span><span class="p">),</span> <span class="mi">1024</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">low_loss</span><span class="p">)))</span>
                <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">low_loss</span><span class="o">/</span><span class="n">low_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;original_onset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;chemical_shift&#39;</span><span class="p">]</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;X_section_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;XRPA&#39;</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;X_section_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pyTEMlib&#39;</span>

    <span class="k">return</span> <span class="n">edges</span></div>


<div class="viewcode-block" id="power_law"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.power_law.html#pyTEMlib.eels_tools.power_law">[docs]</a><span class="k">def</span> <span class="nf">power_law</span><span class="p">(</span><span class="n">energy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span><span class="nb">float</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;power law for power_law_background&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span><span class="p">)</span></div>


<div class="viewcode-block" id="power_law_background"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.power_law_background.html#pyTEMlib.eels_tools.power_law_background">[docs]</a><span class="k">def</span> <span class="nf">power_law_background</span><span class="p">(</span><span class="n">spectrum</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fit_area</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;fit of power law to spectrum &quot;&quot;&quot;</span>

    <span class="c1"># Determine energy window  for background fit in pixels</span>
    <span class="n">startx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">fit_area</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">endx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">fit_area</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">)[</span><span class="n">startx</span><span class="p">:</span><span class="n">endx</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)[</span><span class="n">startx</span><span class="p">:</span><span class="n">endx</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Initial values of parameters</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0E+20</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="c1"># background fitting</span>
    <span class="k">def</span> <span class="nf">bgdfit</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">-</span> <span class="n">power_law</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">err</span>

    <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">bgdfit</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>

    <span class="n">background_difference</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">power_law</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">background_noise_level</span> <span class="o">=</span> <span class="n">std_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">background_difference</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Power-law background with amplitude A: </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> and exponent -r: </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">background_difference</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">background_noise_level</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Noise level in spectrum </span><span class="si">{</span><span class="n">std_dev</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> counts&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate background over the whole energy scale</span>
    <span class="n">background</span> <span class="o">=</span> <span class="n">power_law</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">background</span><span class="p">,</span> <span class="n">p</span></div>


<div class="viewcode-block" id="cl_model"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.cl_model.html#pyTEMlib.eels_tools.cl_model">[docs]</a><span class="k">def</span> <span class="nf">cl_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">number_of_edges</span><span class="p">,</span> <span class="n">xsec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; core loss model for fitting&quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">])))</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_edges</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">xsec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">y</span></div>


<div class="viewcode-block" id="fit_edges2"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.fit_edges2.html#pyTEMlib.eels_tools.fit_edges2">[docs]</a><span class="k">def</span> <span class="nf">fit_edges2</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="n">edges</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;fit edges for quantification&quot;&quot;&quot;</span>

    <span class="n">dispersion</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Determine fitting ranges and masks to exclude ranges</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span>

    <span class="n">background_fit_start</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;fit_start&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;fit_end&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">energy_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;fit_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">background_fit_end</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;fit_end&#39;</span><span class="p">]</span>

    <span class="n">startx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">background_fit_start</span><span class="p">)</span>
    <span class="n">endx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">background_fit_end</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">startx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">endx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_exclude&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">background_fit_start</span> <span class="o">+</span> <span class="n">dispersion</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_exclude&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">background_fit_end</span> <span class="o">-</span> <span class="n">dispersion</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;end_exclude&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">background_fit_end</span> <span class="o">-</span> <span class="n">dispersion</span><span class="p">:</span>
                        <span class="c1"># we need at least one channel to fit.</span>
                        <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;end_exclude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">background_fit_end</span> <span class="o">-</span> <span class="n">dispersion</span>
                    <span class="n">startx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_exclude&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">startx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">startx</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">endx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;end_exclude&#39;</span><span class="p">])</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">startx</span><span class="p">:</span> <span class="n">endx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1">########################</span>
    <span class="c1"># Background Fit</span>
    <span class="c1">########################</span>
    <span class="n">bgd_fit_area</span> <span class="o">=</span> <span class="p">[</span><span class="n">background_fit_start</span><span class="p">,</span> <span class="n">background_fit_end</span><span class="p">]</span>
    <span class="n">background</span><span class="p">,</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">power_law_background</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="n">bgd_fit_area</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#######################</span>
    <span class="c1"># Edge Fit</span>
    <span class="c1">#######################</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">energy_scale</span>
    <span class="n">blurred</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">blurred</span>  <span class="c1"># now in probability</span>
    <span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e-8</span>

    <span class="n">xsec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">number_of_edges</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">xsec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="n">number_of_edges</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">xsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xsec</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">pp</span><span class="p">):</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">*</span> <span class="n">xx</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_edges</span><span class="p">):</span>
            <span class="n">pp</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pp</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">xsec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">yy</span>

    <span class="k">def</span> <span class="nf">residuals</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">yy</span> <span class="o">-</span> <span class="n">model</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">pp</span><span class="p">))</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span>  <span class="c1"># / np.sqrt(np.abs(y))</span>
        <span class="k">return</span> <span class="n">err</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span>
    <span class="n">pin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">A</span><span class="p">,</span><span class="n">r</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">scale</span><span class="o">/</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_edges</span><span class="p">)</span>
    <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;areal_density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">background</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background-poly_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background-poly_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background-poly_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background-A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background-r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;spectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;blurred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blurred</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;fit_parameter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;fit_area_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;fit_start&#39;</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;fit_area_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;fit_end&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">edges</span></div>


<div class="viewcode-block" id="fit_edges"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.fit_edges.html#pyTEMlib.eels_tools.fit_edges">[docs]</a><span class="k">def</span> <span class="nf">fit_edges</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="n">region_tags</span><span class="p">,</span> <span class="n">edges</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;fit edges for quantification&quot;&quot;&quot;</span>

    <span class="c1"># Determine fitting ranges and masks to exclude ranges</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span>

    <span class="n">background_fit_end</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">region_tags</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">region_tags</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">region_tags</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;width_x&#39;</span><span class="p">]</span>

        <span class="n">startx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">region_tags</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_x&#39;</span><span class="p">])</span>
        <span class="n">endx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fit_area&#39;</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">startx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">endx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">startx</span><span class="p">:</span><span class="n">endx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">region_tags</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">background_fit_end</span><span class="p">:</span>  <span class="c1"># Which is the onset of the first edge?</span>
                <span class="n">background_fit_end</span> <span class="o">=</span> <span class="n">region_tags</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;start_x&#39;</span><span class="p">]</span>

    <span class="c1">########################</span>
    <span class="c1"># Background Fit</span>
    <span class="c1">########################</span>
    <span class="n">bgd_fit_area</span> <span class="o">=</span> <span class="p">[</span><span class="n">region_tags</span><span class="p">[</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;start_x&#39;</span><span class="p">],</span> <span class="n">background_fit_end</span><span class="p">]</span>
    <span class="n">background</span><span class="p">,</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">power_law_background</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">energy_scale</span><span class="p">,</span> <span class="n">bgd_fit_area</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#######################</span>
    <span class="c1"># Edge Fit</span>
    <span class="c1">#######################</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">energy_scale</span>
    <span class="n">blurred</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">blurred</span>  <span class="c1"># now in probability</span>
    <span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e-8</span>

    <span class="n">xsec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">number_of_edges</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">xsec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="n">number_of_edges</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">xsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xsec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">pp</span><span class="p">):</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">background</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">*</span> <span class="n">xx</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_edges</span><span class="p">):</span>
            <span class="n">pp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">xsec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">yy</span>

    <span class="k">def</span> <span class="nf">residuals</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">yy</span> <span class="o">-</span> <span class="n">model</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">pp</span><span class="p">))</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span>  <span class="c1"># / np.sqrt(np.abs(y))</span>
        <span class="k">return</span> <span class="n">err</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span>
    <span class="n">pin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">scale</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="n">scale</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="n">scale</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="n">scale</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="n">scale</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="n">scale</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="n">scale</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">])</span>
    <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;areal_density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">background</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background-poly_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background-poly_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background-poly_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background-A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;background-r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;spectrum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;blurred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blurred</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;fit_parameter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;fit_area_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_tags</span><span class="p">[</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;start_x&#39;</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;fit_area_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region_tags</span><span class="p">[</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;start_x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">region_tags</span><span class="p">[</span><span class="s1">&#39;fit_area&#39;</span><span class="p">][</span><span class="s1">&#39;width_x&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">edges</span></div>



<div class="viewcode-block" id="get_spectrum"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.get_spectrum.html#pyTEMlib.eels_tools.get_spectrum">[docs]</a><span class="k">def</span> <span class="nf">get_spectrum</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bin_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bin_y</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    dataset: sidpy.Dataset object</span>
<span class="sd">        contains spectrum or spectrum image</span>
<span class="sd">    x: int default = 0</span>
<span class="sd">        x position of spectrum image</span>
<span class="sd">    y: int default = 0</span>
<span class="sd">        y position of spectrum</span>
<span class="sd">    bin_x: int default = 1</span>
<span class="sd">        binning of spectrum image in x-direction</span>
<span class="sd">    bin_y: int default = 1</span>
<span class="sd">        binning of spectrum image in y-direction</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    spectrum: sidpy.Dataset object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;SPECTRUM&#39;</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image_dims</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_image_dims</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">image_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">bin_x</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">image_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">bin_x</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">image_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">bin_y</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">image_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">bin_y</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_dimension_types</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dimension_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dimensions</span><span class="p">):</span>
            <span class="c1"># print(dim, axis.dimension_type)</span>
            <span class="k">if</span> <span class="n">dimension_type</span> <span class="o">==</span> <span class="s1">&#39;SPATIAL&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="n">image_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">selection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">bin_x</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bin_y</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">dimension_type</span> <span class="o">==</span> <span class="s1">&#39;SPECTRAL&#39;</span><span class="p">:</span>
                <span class="n">selection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">dimension_type</span> <span class="o">==</span> <span class="s1">&#39;CHANNEL&#39;</span><span class="p">:</span>
                <span class="n">selection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">selection</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">image_dims</span><span class="p">))</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;Spectrum&#39;</span>
    <span class="k">return</span> <span class="n">spectrum</span></div>

<div class="viewcode-block" id="find_peaks"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.find_peaks.html#pyTEMlib.eels_tools.find_peaks">[docs]</a><span class="k">def</span> <span class="nf">find_peaks</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">fit_start</span><span class="p">,</span> <span class="n">fit_end</span><span class="p">,</span> <span class="n">sensitivity</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;find peaks in spectrum&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;SPECTRAL_IMAGE&#39;</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">get_spectrum</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spectral_dims</span><span class="p">(</span><span class="n">return_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">second_dif</span><span class="p">,</span> <span class="n">noise_level</span> <span class="o">=</span> <span class="n">second_derivative</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">sensitivity</span><span class="o">=</span><span class="n">sensitivity</span><span class="p">)</span>
    <span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="o">-</span><span class="n">second_dif</span><span class="p">,</span> <span class="n">noise_level</span><span class="p">)</span>

    <span class="n">start_channel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">fit_start</span><span class="p">)</span>
    <span class="n">end_channel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">fit_end</span><span class="p">)</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">start_channel</span> <span class="o">&lt;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_channel</span><span class="p">:</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="n">start_channel</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="n">start_channel</span><span class="p">:</span><span class="n">end_channel</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;edges&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;spectrum&#39;</span><span class="p">][</span><span class="n">start_channel</span><span class="p">:</span><span class="n">end_channel</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">end_channel</span> <span class="o">-</span> <span class="n">start_channel</span><span class="p">)</span>

    <span class="n">energy_scale</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="n">start_channel</span><span class="p">:</span><span class="n">end_channel</span><span class="p">]</span>

    <span class="n">difference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)[</span><span class="n">start_channel</span><span class="p">:</span><span class="n">end_channel</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">))</span>
    <span class="n">p_out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">([[</span><span class="n">energy_scale</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">difference</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">.7</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">])</span>
        <span class="p">[</span><span class="n">p_out</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">residuals_smooth</span><span class="p">,</span> <span class="n">p_in</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span>
                                                                                     <span class="n">difference</span><span class="p">,</span>
                                                                                     <span class="kc">False</span><span class="p">))</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">fit</span> <span class="o">+</span> <span class="n">model_smooth</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">p_out</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">peak_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span>
    <span class="n">peak_model</span><span class="p">[</span><span class="n">start_channel</span><span class="p">:</span><span class="n">end_channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span>

    <span class="k">return</span> <span class="n">peak_model</span><span class="p">,</span> <span class="n">p_out</span></div>


<div class="viewcode-block" id="find_maxima"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.find_maxima.html#pyTEMlib.eels_tools.find_maxima">[docs]</a><span class="k">def</span> <span class="nf">find_maxima</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">number_of_peaks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; find the first most prominent peaks</span>

<span class="sd">    peaks are then sorted by energy</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y: numpy array</span>
<span class="sd">        (part) of spectrum</span>
<span class="sd">    number_of_peaks: int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy array</span>
<span class="sd">        indices of peaks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">blurred2</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">blurred2</span><span class="p">)</span>
    <span class="n">prominences</span> <span class="o">=</span> <span class="n">peak_prominences</span><span class="p">(</span><span class="n">blurred2</span><span class="p">,</span> <span class="n">peaks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">prominences_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">prominences</span><span class="p">)</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="n">prominences_sorted</span><span class="p">[</span><span class="o">-</span><span class="n">number_of_peaks</span><span class="p">:]]</span>

    <span class="n">peak_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">peaks</span><span class="p">[</span><span class="n">peak_indices</span><span class="p">]</span></div>


<span class="c1"># </span>
<div class="viewcode-block" id="model3"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.model3.html#pyTEMlib.eels_tools.model3">[docs]</a><span class="k">def</span> <span class="nf">model3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">number_of_peaks</span><span class="p">,</span> <span class="n">peak_shape</span><span class="p">,</span> <span class="n">p_zl</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">restrict_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">restrict_width</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; model for fitting low-loss spectrum&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">p</span>

    <span class="c1"># if len([restrict_pos]) == 1:</span>
    <span class="c1">#    restrict_pos = [restrict_pos]*number_of_peaks</span>
    <span class="c1"># if len([restrict_width]) == 1:</span>
    <span class="c1">#    restrict_width = [restrict_width]*number_of_peaks</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_peaks</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">restrict_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pin</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">restrict_pos</span><span class="p">):</span>
                <span class="n">p</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">restrict_pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pin</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">restrict_pos</span><span class="p">):</span>
                <span class="n">p</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">restrict_pos</span><span class="p">)</span>

        <span class="n">p</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="c1"># print(p[index + 1])</span>
        <span class="n">p</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">restrict_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pin</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">restrict_width</span><span class="p">):</span>
                <span class="n">p</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">restrict_width</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">peak_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Lorentzian&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">lorentz</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">index</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="n">peak_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;zl&#39;</span><span class="p">:</span>

            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">zl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">index</span><span class="p">:],</span> <span class="n">p_zl</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">index</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">y</span></div>


<div class="viewcode-block" id="sort_peaks"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.sort_peaks.html#pyTEMlib.eels_tools.sort_peaks">[docs]</a><span class="k">def</span> <span class="nf">sort_peaks</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">peak_shape</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;sort fitting parameters by peak position&quot;&quot;&quot;</span>
    <span class="n">number_of_peaks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">number_of_peaks</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">sort_pin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">p3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">p3</span><span class="p">[</span><span class="n">sort_pin</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">peak_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peak_shape</span><span class="p">)[</span><span class="n">sort_pin</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">peak_shape</span></div>


<div class="viewcode-block" id="add_peaks"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.add_peaks.html#pyTEMlib.eels_tools.add_peaks">[docs]</a><span class="k">def</span> <span class="nf">add_peaks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">pin_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">peak_shape_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;Gaussian&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; add peaks to fitting parameters&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pin_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">peak_shape_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">pin</span> <span class="o">=</span> <span class="n">pin_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">peak_shape</span> <span class="o">=</span> <span class="n">peak_shape_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># if peak_shape is only a string make a list of it.</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">peak</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peaks</span><span class="p">):</span>
        <span class="n">pin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">peak</span><span class="p">])</span>
        <span class="n">pin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">peak</span><span class="p">])</span>
        <span class="n">pin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">.3</span><span class="p">)</span>
        <span class="n">peak_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">pin</span><span class="p">,</span> <span class="n">peak_shape</span></div>


<div class="viewcode-block" id="fit_model"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.fit_model.html#pyTEMlib.eels_tools.fit_model">[docs]</a><span class="k">def</span> <span class="nf">fit_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">number_of_peaks</span><span class="p">,</span> <span class="n">peak_shape</span><span class="p">,</span> <span class="n">p_zl</span><span class="p">,</span> <span class="n">restrict_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">restrict_width</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;model for fitting low-loss spectrum&quot;&quot;&quot;</span>

    <span class="n">pin_original</span> <span class="o">=</span> <span class="n">pin</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">residuals3</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">model3</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">number_of_peaks</span><span class="p">,</span> <span class="n">peak_shape</span><span class="p">,</span> <span class="n">p_zl</span><span class="p">,</span> <span class="n">pin_original</span><span class="p">,</span> <span class="n">restrict_pos</span><span class="p">,</span>
                           <span class="n">restrict_width</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">err</span>

    <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">residuals3</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="c1"># p2 = p.tolist()</span>
    <span class="c1"># p3 = np.reshape(p2, (number_of_peaks, 3))</span>
    <span class="c1"># sort_pin = np.argsort(p3[:, 0])</span>

    <span class="c1"># p = p3[sort_pin].flatten()</span>
    <span class="c1"># peak_shape = np.array(peak_shape)[sort_pin].tolist()</span>

    <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">peak_shape</span></div>



<div class="viewcode-block" id="plot_dispersion"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.plot_dispersion.html#pyTEMlib.eels_tools.plot_dispersion">[docs]</a><span class="k">def</span> <span class="nf">plot_dispersion</span><span class="p">(</span><span class="n">plotdata</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">a_data</span><span class="p">,</span> <span class="n">e_data</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">max_p</span><span class="p">,</span> <span class="n">ee</span><span class="p">,</span> <span class="n">ef</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span> <span class="n">ep</span><span class="o">=</span><span class="mf">16.8</span><span class="p">,</span> <span class="n">es</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ibt</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot loss function &quot;&quot;&quot;</span>

    <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">e_data</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="n">a_data</span><span class="p">[</span><span class="mi">1024</span><span class="p">:</span><span class="mi">2048</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">plotdata</span>
    <span class="n">lev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">4.9</span><span class="p">])</span> <span class="o">*</span> <span class="n">max_p</span> <span class="o">/</span> <span class="mi">5</span>

    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">get_wave_length</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">a_data</span><span class="p">[</span><span class="mi">1024</span><span class="p">:</span><span class="mi">2048</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">wavelength</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span>  <span class="c1"># in [1/nm]</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">e_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">ev2hertz</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;electron volt-hertz relationship&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mrad&#39;</span><span class="p">:</span>
        <span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scattering angle [mrad]&#39;</span>
        <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.</span>
        <span class="n">light_line</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">a_data</span>  <span class="c1"># for mrad</span>
    <span class="k">elif</span> <span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1/nm&#39;</span><span class="p">:</span>
        <span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scattering vector [1/nm]&#39;</span>
        <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">wavelength</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span>
        <span class="n">light_line</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">ev2hertz</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-9</span>

    <span class="k">if</span> <span class="n">units</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;eV&#39;</span><span class="p">:</span>
        <span class="n">units</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;energy loss [eV]&#39;</span>

    <span class="k">if</span> <span class="n">units</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ppm&#39;</span><span class="p">:</span>
        <span class="n">units</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;probability [ppm]&#39;</span>
    <span class="k">if</span> <span class="n">units</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1/eV&#39;</span><span class="p">:</span>
        <span class="n">units</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;probability [eV$^{-1}$ srad$^{-1}$]&#39;</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">3.</span> <span class="o">/</span> <span class="mf">5.</span> <span class="o">*</span> <span class="n">ef</span> <span class="o">/</span> <span class="n">ep</span>

    <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">fig2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_p</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">lev</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="c1"># ,extent=(-ang*1000.,ang*1000.,e_data[0],e_data[-1]))#, vmin = p_vol.min(), vmax = 1000)</span>

    <span class="n">fig2</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">units</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">a_data</span><span class="p">,</span> <span class="n">light_line</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;light line&#39;</span><span class="p">)</span>
    <span class="c1"># ax2.plot(e_data*light_line*np.sqrt(np.real(eps_data)),e_data, color=&#39;steelblue&#39;,</span>
    <span class="c1"># label=&#39;$\omega = c q \sqrt{\epsilon_2}$&#39;)</span>

    <span class="c1"># ax2.plot(q, Ep_disp, c=&#39;r&#39;)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">11.5</span> <span class="o">*</span> <span class="n">light_line</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">],</span> <span class="p">[</span><span class="mf">11.5</span><span class="p">,</span> <span class="mf">11.5</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">.05</span><span class="p">,</span> <span class="mf">11.7</span><span class="p">,</span> <span class="s1">&#39;surface plasmon&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">],</span> <span class="p">[</span><span class="mf">16.8</span><span class="p">,</span> <span class="mf">16.8</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">.05</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;volume plasmon&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="c1"># Interband transitions</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.2</span><span class="p">,</span> <span class="mf">4.2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;interband transitions&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span> <span class="p">[</span><span class="mf">5.2</span><span class="p">,</span> <span class="mf">5.2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="xsec_xrpa"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.xsec_xrpa.html#pyTEMlib.eels_tools.xsec_xrpa">[docs]</a><span class="k">def</span> <span class="nf">xsec_xrpa</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Calculate momentum-integrated cross-section for EELS from X-ray photo-absorption cross-sections.</span>

<span class="sd">    X-ray photo-absorption cross-sections from NIST.</span>
<span class="sd">    Momentum-integrated cross-section for EELS according to Egerton Ultramicroscopy 50 (1993) 13-28 equation (4)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    energy_scale: numpy array</span>
<span class="sd">        energy scale of spectrum to be analyzed</span>
<span class="sd">    e0: float</span>
<span class="sd">        acceleration voltage in keV</span>
<span class="sd">    z: int</span>
<span class="sd">        atomic number of element</span>
<span class="sd">    beta: float</span>
<span class="sd">        effective collection angle in mrad</span>
<span class="sd">    shift: float</span>
<span class="sd">        chemical shift of edge in eV</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="mf">0.001</span>  <span class="c1"># collection half angle theta [rad]</span>
    <span class="c1"># theta_max = self.parent.spec[0].convAngle * 0.001  # collection half angle theta [rad]</span>
    <span class="n">dispersion</span> <span class="o">=</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">x_sections</span> <span class="o">=</span> <span class="n">get_x_sections</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">enexs</span> <span class="o">=</span> <span class="n">x_sections</span><span class="p">[</span><span class="s1">&#39;ene&#39;</span><span class="p">]</span>
    <span class="n">datxs</span> <span class="o">=</span> <span class="n">x_sections</span><span class="p">[</span><span class="s1">&#39;dat&#39;</span><span class="p">]</span>

    <span class="c1"># enexs = enexs[:len(datxs)]</span>

    <span class="c1">#####</span>
    <span class="c1"># Cross Section according to Egerton Ultramicroscopy 50 (1993) 13-28 equation (4)</span>
    <span class="c1">#####</span>

    <span class="c1"># Relativistic correction factors</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mf">511060.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">e0</span> <span class="o">/</span> <span class="mf">511.06</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">e0</span> <span class="o">/</span> <span class="mf">511.06</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">6.5</span>  <span class="c1"># e-14 *10**14</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">beta</span>

    <span class="n">theta_e</span> <span class="o">=</span> <span class="n">enexs</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">g</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">theta_e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">theta_e</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">gamma</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">theta_e</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">datxs</span> <span class="o">=</span> <span class="n">datxs</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="n">enexs</span> <span class="o">/</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">b</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">theta_e</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e8</span>

    <span class="n">datxs</span> <span class="o">=</span> <span class="n">datxs</span> <span class="o">*</span> <span class="n">dispersion</span>  <span class="c1"># from per eV to per dispersion</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">enexs</span><span class="p">,</span> <span class="n">datxs</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># now in areal density atoms / m^2</span>
    <span class="n">xsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">))</span>
    <span class="c1"># shift = 0# int(ek -onsetXRPS)#/dispersion</span>
    <span class="n">lin</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">enexs</span><span class="p">,</span> <span class="n">datxs</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>  <span class="c1"># Linear instead of spline interpolation to avoid oscillations.</span>
    <span class="k">if</span> <span class="n">energy_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">enexs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">,</span> <span class="n">enexs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">xsec</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span> <span class="o">=</span> <span class="n">lin</span><span class="p">(</span><span class="n">energy_scale</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span> <span class="o">-</span> <span class="n">shift</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xsec</span></div>


<span class="c1">##########################</span>
<span class="c1"># EELS Database</span>
<span class="c1">##########################</span>


<div class="viewcode-block" id="read_msa"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.read_msa.html#pyTEMlib.eels_tools.read_msa">[docs]</a><span class="k">def</span> <span class="nf">read_msa</span><span class="p">(</span><span class="n">msa_string</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;read msa formated file&quot;&quot;&quot;</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Read the keywords</span>
    <span class="n">data_section</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">msa_lines</span> <span class="o">=</span> <span class="n">msa_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">msa_lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data_section</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">line</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;SPECTRUM&#39;</span><span class="p">:</span>
                        <span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data_section</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Read the data</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;#&quot;</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;DATATYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;XY&#39;</span><span class="p">:</span>
                    <span class="n">xy</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;DATATYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                    <span class="n">y</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;XPERCHAN&#39;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;XPERCHAN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;XPERCHAN&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;OFFSET&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;OFFSET&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;energy_scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;XPERCHAN&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;OFFSET&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">parameters</span></div>


<div class="viewcode-block" id="get_spectrum_eels_db"><a class="viewcode-back" href="../../_autosummary/pyTEMlib.eels_tools.get_spectrum_eels_db.html#pyTEMlib.eels_tools.get_spectrum_eels_db">[docs]</a><span class="k">def</span> <span class="nf">get_spectrum_eels_db</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get spectra from EELS database</span>
<span class="sd">    chemical formula and edge is accepted.</span>
<span class="sd">    Could expose more of the search parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_edges</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;L1&#39;</span><span class="p">,</span> <span class="s1">&#39;L2,3&#39;</span><span class="p">,</span> <span class="s1">&#39;M2,3&#39;</span><span class="p">,</span> <span class="s1">&#39;M4,5&#39;</span><span class="p">,</span> <span class="s1">&#39;N2,3&#39;</span><span class="p">,</span> <span class="s1">&#39;N4,5&#39;</span><span class="p">,</span> <span class="s1">&#39;O2,3&#39;</span><span class="p">,</span> <span class="s1">&#39;O4,5&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_edges</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;edge should be a in &#39;</span><span class="p">,</span> <span class="n">valid_edges</span><span class="p">)</span>

    <span class="n">spectrum_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
    <span class="n">author</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
    <span class="n">min_energy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_energy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">min_energy_compare</span> <span class="o">=</span> <span class="s2">&quot;gt&quot;</span>
    <span class="n">max_energy_compare</span> <span class="o">=</span> <span class="s2">&quot;lt&quot;</span><span class="p">,</span>
    <span class="n">resolution_compare</span> <span class="o">=</span> <span class="s2">&quot;lt&quot;</span>
    <span class="n">max_n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">monochromated</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">order</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">order_direction</span> <span class="o">=</span> <span class="s2">&quot;ASC&quot;</span>
    <span class="n">verify_certificate</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Verify arguments</span>

    <span class="k">if</span> <span class="n">spectrum_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">spectrum_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;coreloss&#39;</span><span class="p">,</span> <span class="s1">&#39;lowloss&#39;</span><span class="p">,</span> <span class="s1">&#39;zeroloss&#39;</span><span class="p">,</span> <span class="s1">&#39;xrayabs&#39;</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;spectrum_type must be one of </span><span class="se">\&#39;</span><span class="s2">coreloss</span><span class="se">\&#39;</span><span class="s2">, </span><span class="se">\&#39;</span><span class="s2">lowloss</span><span class="se">\&#39;</span><span class="s2">, &quot;</span>
                         <span class="s2">&quot;</span><span class="se">\&#39;</span><span class="s2">zeroloss</span><span class="se">\&#39;</span><span class="s2">, </span><span class="se">\&#39;</span><span class="s2">xrayabs</span><span class="se">\&#39;</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="c1"># valid_edges = [&#39;K&#39;, &#39;L1&#39;, &#39;L2,3&#39;, &#39;M2,3&#39;, &#39;M4,5&#39;, &#39;N2,3&#39;, &#39;N4,5&#39;, &#39;O2,3&#39;, &#39;O4,5&#39;]</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">spectrum_type</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="n">author</span><span class="p">,</span>
        <span class="s2">&quot;edge&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="p">,</span>
        <span class="s2">&quot;min_energy&quot;</span><span class="p">:</span> <span class="n">min_energy</span><span class="p">,</span>
        <span class="s2">&quot;max_energy&quot;</span><span class="p">:</span> <span class="n">max_energy</span><span class="p">,</span>
        <span class="s2">&quot;resolution&quot;</span><span class="p">:</span> <span class="n">resolution</span><span class="p">,</span>
        <span class="s2">&quot;resolution_compare&quot;</span><span class="p">:</span> <span class="n">resolution_compare</span><span class="p">,</span>
        <span class="s2">&quot;monochromated&quot;</span><span class="p">:</span> <span class="n">monochromated</span><span class="p">,</span>
        <span class="s2">&quot;formula&quot;</span><span class="p">:</span> <span class="n">formula</span><span class="p">,</span>
        <span class="s1">&#39;element&#39;</span><span class="p">:</span> <span class="n">element</span><span class="p">,</span>
        <span class="s2">&quot;min_energy_compare&quot;</span><span class="p">:</span> <span class="n">min_energy_compare</span><span class="p">,</span>
        <span class="s2">&quot;max_energy_compare&quot;</span><span class="p">:</span> <span class="n">max_energy_compare</span><span class="p">,</span>
        <span class="s2">&quot;per_page&quot;</span><span class="p">:</span> <span class="n">max_n</span><span class="p">,</span>
        <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
        <span class="s2">&quot;order_direction&quot;</span><span class="p">:</span> <span class="n">order_direction</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">request</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.eelsdb.eu/spectra&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># spectra = []</span>
    <span class="n">jsons</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;message&quot;</span> <span class="ow">in</span> <span class="n">jsons</span><span class="p">:</span>
        <span class="c1"># Invalid query, EELSdb raises error.</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
            <span class="s2">&quot;Please report the following error to the HyperSpy developers: &quot;</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">jsons</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
    <span class="n">reference_spectra</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">json_spectrum</span> <span class="ow">in</span> <span class="n">jsons</span><span class="p">:</span>
        <span class="n">download_link</span> <span class="o">=</span> <span class="n">json_spectrum</span><span class="p">[</span><span class="s1">&#39;download_link&#39;</span><span class="p">]</span>
        <span class="c1"># print(download_link)</span>
        <span class="n">msa_string</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">download_link</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="n">verify_certificate</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="c1"># print(msa_string[:100])</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">read_msa</span><span class="p">(</span><span class="n">msa_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;XPERCHAN&#39;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="n">reference_spectra</span><span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;TITLE&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">parameters</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;TITLE&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">reference_spectra</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1"> spectra in EELS database)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reference_spectra</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Gerd Duscher, and contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>